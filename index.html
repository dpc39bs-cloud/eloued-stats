<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منظومة الحصيلة الرقمية - ولاية الوادي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary:#1a237e; --accent:#c62828; --success:#2e7d32; --danger:#d32f2f; --bg:#f4f7f9; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; direction: rtl; }
        .hidden { display: none !important; }
        /* إلغاء أزرار الزيادة والنقصان */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .container { zoom: 90%; padding: 20px; width: 98%; margin: auto; background: white; min-height: 100vh; }
        #login-page { background: linear-gradient(rgba(26, 35, 126, 0.88), rgba(13, 71, 161, 0.85)), url('https://www.wilaya-eloued.dz/images/slider/s1.jpg'); background-size: cover; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 25px; border-radius: 25px; text-align: center; width: 320px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .input-field { font-family: 'Cairo'; width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #eee; margin-bottom: 10px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 2.5px solid #000; }
        th, td { border: 2px solid #000; padding: 5px; text-align: center; }
        th { background: var(--primary) !important; color: white !important; font-size: 14px; }
        .editable { width: 90%; border: 1px solid #ccc; text-align: center; font-weight: 700; font-size: 17px; }
        .btn { font-family: 'Cairo'; padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; margin: 5px; color: white; transition: 0.3s; }

        @media print {
            .no-print { display: none !important; }
            .print-section { display: block !important; width: 100% !important; page-break-after: always; }
        }
    </style>
</head>
<body>

<div id="login-page">
    <div class="login-card">
        <h2 style="color: var(--primary);">منظومة الحصيلة الرقمية</h2>
        <select id="user-role" class="input-field"></select>
        <input type="password" id="pass-code" class="input-field" placeholder="كلمة المرور">
        <button onclick="login()" class="btn" style="background: var(--primary); width: 100%;">دخول</button>
    </div>
</div>

<div id="app-content" class="hidden">
    <div class="container">
        <div id="master-notif-panel" class="hidden no-print" style="background: #e3f2fd; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
             <div style="display: flex; gap: 10px;">
                <select id="notif-target" class="input-field" style="width: 20%; margin:0;"></select>
                <input type="text" id="notif-msg" class="input-field" style="width: 60%; margin:0;" placeholder="إرسال تنبيه للوحدة...">
                <button onclick="sendNotif()" class="btn" style="background: var(--primary); margin:0;">إرسال</button>
            </div>
        </div>

        <div class="no-print" style="text-align:center; margin-bottom: 20px;">
            <label style="font-weight: 800;">اختر الأسبوع للعرض/الإدخال: </label>
            <input type="week" id="week-picker" class="input-field" style="width: auto;" onchange="changeWeek()">
        </div>

        <div id="capture-area">
            <div class="print-section">
                <h3 id="table-title" style="text-align:center; border: 2px solid #000; padding: 10px;">حصيلة النشاط اليومي</h3>
                <table id="daily-table">
                    <thead>
                        <tr><th rowspan="2">التاريخ</th><th colspan="4">الإسعاف</th><th colspan="4">حوادث المرور</th><th colspan="4">الحرائق</th><th colspan="4">مختلفة</th><th rowspan="2">ع ت</th></tr>
                        <tr style="background:#eee; color:black;"><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th></tr>
                    </thead>
                    <tbody id="daily-body"></tbody>
                    <tfoot id="daily-foot" style="background:#f1f1f1; font-weight:bold;"></tfoot>
                </table>
            </div>
        </div>

        <div id="archive-section" class="no-print" style="background:#fff; padding:20px; border-radius:15px; border:2px solid var(--primary); margin: 30px 0;">
            <h3 style="color:var(--primary);"><i class="fa-solid fa-calendar-check"></i> استخراج الحصيلة الشهرية</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div><label>1. السنة</label><select id="arc-year" class="input-field" onchange="updateMonthFilter()"></select></div>
                <div><label>2. الشهر</label><select id="arc-month" class="input-field"></select></div>
                <div style="display:flex; align-items:flex-end;">
                    <button onclick="generateMonthlyReport()" class="btn" style="background:#6a1b9a; width:100%; margin-bottom:10px;">
                        <i class="fa-solid fa-eye"></i> إظهار الحصيلة الشهرية
                    </button>
                </div>
            </div>
        </div>

        <div id="monthly-report-area" class="hidden">
            <div id="monthly-print-box" style="padding: 20px; border: 3px double #000; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; text-align: center; align-items: center; margin-bottom: 20px;">
                    <div>الحماية المدنية<br>ولاية الوادي</div>
                    <div><h2 style="margin:0;">الحصيلة الشهرية للنشاط</h2><div id="m-info" style="font-weight:bold; color:blue;"></div></div>
                    <div>مكتب الإحصاء</div>
                </div>
                <table>
                    <thead>
                        <tr><th rowspan="2">البيان</th><th colspan="4">الإسعاف</th><th colspan="4">حوادث المرور</th><th colspan="4">الحرائق</th><th colspan="4">مختلفة</th><th rowspan="2">ع ت</th></tr>
                        <tr style="background:#eee; color:black;"><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th><th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th></tr>
                    </thead>
                    <tbody id="monthly-result-body"></tbody>
                </table>
                <div class="no-print" style="text-align:center;">
                    <button class="btn" style="background:var(--success)" onclick="printMonthlyOnly()"><i class="fa-solid fa-print"></i> طباعة هذه الحصيلة</button>
                    <button class="btn" style="background:var(--danger)" onclick="document.getElementById('monthly-report-area').classList.add('hidden')">إغلاق ×</button>
                </div>
            </div>
        </div>

        <div class="no-print" style="text-align:center; margin-top: 30px;">
            <button class="btn" style="background:var(--success)" onclick="saveData()">حفظ أونلاين ✅</button>
            <button class="btn" style="background:#546e7a" onclick="location.reload()">خروج</button>
        </div>
    </div>
</div>

<script>
// إعدادات Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBxYbKWfBM-e2wE1ry_SNDSDaSi2k3IgHY",
    authDomain: "eloued-system.firebaseapp.com",
    projectId: "eloued-system",
    databaseURL: "https://eloued-system-default-rtdb.firebaseio.com",
    storageBucket: "eloued-system.appspot.com",
    messagingSenderId: "215124234121",
    appId: "1:215124234121:web:01536290ef78a417a71b58"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const unitConfig = {"المتحكم الرئيسي": [], "الرئيسية": ["الوادي", "كوينين"], "المركز المتقدم": ["الوادي"], "الرباح": ["الرباح", "البياضة"], "ميه ونسة": ["أميه ونسة"], "قمار": ["قمار"], "الدبيلة": ["الدبيلة"], "حاسي خليفة": ["حاسي خليفة"], "المقرن": ["المقرن"], "الرقيبة": ["الرقيبة"], "الحمراية": ["الحمراية"], "الطالب العربي": ["الطالب العربي"], "دوار الماء": ["دوار الماء"]};
let currentUser = ""; let currentWeek = "2026-W07";

window.onload = function() {
    const userSelect = document.getElementById("user-role");
    Object.keys(unitConfig).forEach(u => userSelect.innerHTML += `<option value="${u}">${u}</option>`);
    document.getElementById("week-picker").value = currentWeek;
    loadArchiveYears();
};

async function login() {
    let p = document.getElementById("pass-code").value;
    let u = document.getElementById("user-role").value;
    const snapshot = await db.ref('passwords/' + u).once('value');
    const cloudPass = snapshot.val() || "1111";

    if(p !== cloudPass) return Swal.fire("خطأ", "كلمة المرور خاطئة", "error");
    
    currentUser = u;
    document.getElementById("login-page").classList.add("hidden");
    document.getElementById("app-content").classList.remove("hidden");
    if(currentUser === "المتحكم الرئيسي") document.getElementById("master-notif-panel").classList.remove("hidden");
    renderSystem();
}

async function renderSystem() {
    currentWeek = document.getElementById("week-picker").value;
    const snapshot = await db.ref('data/' + currentWeek).once('value');
    const allData = snapshot.val() || {};
    
    let dBody = document.getElementById("daily-body"); dBody.innerHTML = "";
    for(let i=0; i<7; i++) {
        let rowData = new Array(16).fill(0);
        if(currentUser === "المتحكم الرئيسي") {
            Object.values(allData).forEach(u => { if(u.daily && u.daily[i]) u.daily[i].forEach((v, idx) => rowData[idx] += parseInt(v)||0); });
        } else {
            if(allData[currentUser] && allData[currentUser].daily) rowData = allData[currentUser].daily[i] || rowData;
        }

        let tr = `<tr><td>يوم ${i+1}</td>`;
        rowData.forEach((val, idx) => {
            if(currentUser === "المتحكم الرئيسي") tr += `<td>${val}</td>`;
            else tr += `<td><input type="number" class="editable d-input" data-day="${i}" data-col="${idx}" value="${val}" oninput="calculate()"></td>`;
        });
        tr += `<td class="row-total" style="font-weight:bold; background:#fff3e0;">0</td></tr>`;
        dBody.innerHTML += tr;
    }
    calculate();
}

function calculate() {
    let totals = new Array(16).fill(0);
    document.querySelectorAll("#daily-body tr").forEach(row => {
        let rSum = 0;
        row.querySelectorAll("input, td:not(:first-child):not(.row-total)").forEach((el, idx) => {
            let v = parseInt(el.value || el.innerText) || 0;
            totals[idx] += v;
            if([1,5,9,13].includes(idx)) rSum += v;
        });
        row.querySelector(".row-total").innerText = rSum;
    });
    let foot = document.getElementById("daily-foot");
    let fHtml = `<td>المجموع الكلي</td>`;
    totals.forEach(v => fHtml += `<td>${v}</td>`);
    fHtml += `<td style="background:yellow;">${[1,5,9,13].reduce((a,b)=>a+totals[b],0)}</td>`;
    foot.innerHTML = fHtml;
}

async function saveData() {
    let daily = [];
    document.querySelectorAll(".d-input").forEach(el => {
        if(!daily[el.dataset.day]) daily[el.dataset.day] = [];
        daily[el.dataset.day][el.dataset.col] = el.value;
    });
    await db.ref('data/' + currentWeek + '/' + currentUser).set({daily});
    Swal.fire("تم الحفظ", "تمت المزامنة بنجاح", "success");
}

function loadArchiveYears() {
    const yearSelect = document.getElementById("arc-year");
    for(let i=2025; i<=2030; i++) yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
    updateMonthFilter();
}

function updateMonthFilter() {
    const months = ["جانفي", "فيفري", "مارس", "أفريل", "ماي", "جوان", "جويلية", "أوت", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
    const mSelect = document.getElementById("arc-month");
    mSelect.innerHTML = "";
    months.forEach((m, i) => mSelect.innerHTML += `<option value="${i+1}">${m}</option>`);
}

async function generateMonthlyReport() {
    const year = document.getElementById("arc-year").value;
    const month = document.getElementById("arc-month").value;
    const monthName = document.getElementById("arc-month").options[document.getElementById("arc-month").selectedIndex].text;
    
    Swal.fire({title: 'جاري التجميع...', didOpen: () => Swal.showLoading()});
    
    const snapshot = await db.ref('data').once('value');
    const allData = snapshot.val() || {};
    let monthlyTotal = new Array(16).fill(0);

    Object.keys(allData).forEach(wk => {
        let [y, w] = wk.split('-W');
        let d = new Date(y, 0, 1 + (w - 1) * 7);
        if(y === year && (d.getMonth() + 1) == month) {
            Object.keys(allData[wk]).forEach(u => {
                if(currentUser === "المتحكم الرئيسي" || currentUser === u) {
                    allData[wk][u].daily.forEach(row => {
                        if(row) row.forEach((v, i) => monthlyTotal[i] += parseInt(v)||0);
                    });
                }
            });
        }
    });

    let grandTotal = [1,5,9,13].reduce((a,b)=>a+monthlyTotal[b],0);
    document.getElementById("m-info").innerText = `${monthName} ${year}`;
    document.getElementById("monthly-result-body").innerHTML = `<tr><td style="font-weight:bold;">المجموع الشهري</td>${monthlyTotal.map(v => `<td>${v}</td>`).join('')}<td style="background:yellow; font-weight:bold;">${grandTotal}</td></tr>`;
    document.getElementById("monthly-report-area").classList.remove("hidden");
    Swal.close();
}

function printMonthlyOnly() {
    const content = document.getElementById("monthly-print-box").innerHTML;
    const win = window.open('', '', 'height=700,width=900');
    win.document.write('<html><head><style>body{font-family:Cairo;direction:rtl;padding:20px;} table{width:100%;border-collapse:collapse;} th,td{border:2px solid black;padding:10px;text-align:center;} .no-print{display:none;}</style></head><body>');
    win.document.write(content);
    win.document.write('</body></html>');
    win.document.close();
    win.print();
}

function changeWeek() { renderSystem(); }
</script>
</body>
</html>
