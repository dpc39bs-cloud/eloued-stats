<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>
      Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© - ÙˆÙ„Ø§ÙŠØ© Ø§Ù„ÙˆØ§Ø¯ÙŠ
    </title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js">
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js">
    </script>
    <style>
      /* ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± */
:root { --primary:#1a237e; --accent:#c62828; --success:#2e7d32; --danger:#d32f2f; --bg:#f4f7f9; --warning: #ffc107; }
body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; direction: rtl; overflow-x: hidden; }
.hidden { display: none !important; }
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }
.container { zoom: 90%; padding: 20px; width: 98%; margin: auto; background: white; min-height: 100vh; }
#login-page { background: linear-gradient(rgba(26, 35, 126, 0.88), rgba(13, 71, 161, 0.85)), url('https://www.wilaya-eloued.dz/images/slider/s1.jpg'); background-size: cover; background-position: center; height: 100vh; width: 100vw; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.header-official { text-align: center; color: white; margin-bottom: 15px; line-height: 1.2; }
.header-official h1 { margin: 0; font-size: 2.5rem; font-weight: 900; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
.header-official h2 { margin: 5px 0; font-size: 1.8rem; font-weight: 700; color: #ffd700; }
.header-official h3 { margin: 0; font-size: 1.5rem; font-weight: 600; opacity: 0.9; }
.clock-box { text-align: center; margin-bottom: 20px; background: rgba(255, 255, 255, 0.1); padding: 15px 50px; border-radius: 60px; border: 2px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
#live-clock { font-size: 4.5rem; font-weight: 900; color: white; margin:0; line-height: 1; letter-spacing: 3px; }
#live-date { color: #ffd700; font-weight: 700; font-size: 1.3rem; margin-top: 5px; }
.login-card { background: white; padding: 15px 25px; border-radius: 25px; text-align: center; width: 320px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
.login-card h2 { font-size: 1.4rem; margin-bottom: 15px !important; }
.input-field { font-family: 'Cairo'; width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #eee; font-size: 0.95rem; outline: none; box-sizing: border-box; font-weight: 600; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 2.5px solid #000; table-layout: fixed; }
th, td { border: 2px solid #000; padding: 6px 2px; text-align: center; vertical-align: middle; }
th { background: var(--primary) !important; color: white !important; font-size: 14px; font-weight: 700; }
.sub-head { background: #f1f3f4 !important; font-size: 11px; font-weight: 700; }
.editable { font-family: 'Cairo'; width: 92%; border: none; background: transparent; text-align: center; font-weight: 700; padding: 5px; font-size: 17px; outline: none; }
.btn { font-family: 'Cairo'; padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; margin: 5px; color: white; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
.stats-ticker { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); color: #ffd700; padding: 12px 0; font-weight: 700; z-index: 9999; }
.ticker-content { display: inline-block; white-space: nowrap; animation: ticker 40s linear infinite; }
@keyframes ticker { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
@keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
@keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }

@media print {
    @page { size: A4 landscape; margin: 5mm !important; }
    .no-print, .btn, .stats-ticker, #archive-section, #mainChart, .internal-clock-bar, #status-panel, #week-picker, #master-notif-panel, #unit-notification { display: none !important; }
    .container { zoom: 100% !important; width: 100% !important; padding: 0 !important; }
    .print-section { page-break-after: always; display: block; width: 100% !important; }
    .editable { border: none !important; background: transparent !important; box-shadow: none !important; width: 100% !important; font-size: 18px !important; color: black !important; }
}
    </style>
  </head>
  <body>
    <div class="stats-ticker no-print">
      <div class="ticker-content" id="ticker-text">
        ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ø§ÙŠØ© Ø§Ù„ÙˆØ§Ø¯ÙŠ...
      </div>
    </div>
    <div id="login-page">
      <div class="header-official no-print">
        <h1>
          Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©
        </h1>
        <h2>
          Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© Ù„ÙˆÙ„Ø§ÙŠØ© Ø§Ù„ÙˆØ§Ø¯ÙŠ
        </h2>
        <h3>
          Ù…ØµÙ„Ø­Ø© Ø§Ù„ÙˆÙ‚Ø§ÙŠÙ€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ø©
        </h3>
      </div>
      <div class="clock-box no-print">
        <p id="live-clock">
        </p>
        <p id="live-date">
        </p>
      </div>
      <div class="login-card no-print">
        <h2 style="color: var(--primary); margin:0 0 10px 0; font-weight: 900; border-bottom: 3px solid var(--danger); display: inline-block; padding-bottom: 5px;">
          Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
        </h2>
        
        <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
        <div id="connection-status" style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; padding: 8px; background: #f5f5f5; border-radius: 8px;">
          <div id="status-dot" style="width: 12px; height: 12px; border-radius: 50%; background: #ffc107; animation: pulse 1.5s infinite;"></div>
          <span id="status-text" style="font-size: 13px; font-weight: 700; color: #666;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
        </div>
        
        <select id="user-role" class="input-field" style="margin-bottom: 10px; border: 2px solid var(--primary);">
        </select>
        <input type="password" id="pass-code" class="input-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom: 15px; border: 2px solid var(--primary);" onkeypress="if(event.key==='Enter') login()" />
        <button id="login-btn" onclick="login()" style="background: var(--primary); width: 100%; padding: 12px; border-radius: 10px; font-size: 1.1rem; border:none; color:white; cursor:pointer; font-weight: 900; font-family:'Cairo'; transition: 0.3s;" disabled>
          <i class="fa-solid fa-spinner fa-spin"></i> Ø§Ù†ØªØ¸Ø±...
        </button>
        <div style="font-size: 11px; color: #777; margin-top: 10px; font-weight: 600;">
          Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„: Ø¨Ù† Ø®Ù„ÙŠÙØ© Ø¨Ø¯Ø± Ø§Ù„Ø¯ÙŠÙ†
        </div>
      </div>
    </div>
    <div id="app-content" class="hidden">
      <div class="container">
        <div class="no-print" style="background:#f0f4f8; padding:15px; border-radius:10px; border:2px solid #1a237e; margin-bottom:20px;">
          <h4 style="margin:0 0 10px 0; color:#1a237e;">
            Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©:
          </h4>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="m-year" class="input-field" style="width:120px; margin:0;">
            </select>
            <select id="m-month" class="input-field" style="width:120px; margin:0;">
              <option value="1">
                Ø¬Ø§Ù†ÙÙŠ
              </option>
              <option value="2">
                ÙÙŠÙØ±ÙŠ
              </option>
              <option value="3">
                Ù…Ø§Ø±Ø³
              </option>
              <option value="4">
                Ø£ÙØ±ÙŠÙ„
              </option>
              <option value="5">
                Ù…Ø§ÙŠ
              </option>
              <option value="6">
                Ø¬ÙˆØ§Ù†
              </option>
              <option value="7">
                Ø¬ÙˆÙŠÙ„ÙŠØ©
              </option>
              <option value="8">
                Ø£ÙˆØª
              </option>
              <option value="9">
                Ø³Ø¨ØªÙ…Ø¨Ø±
              </option>
              <option value="10">
                Ø£ÙƒØªÙˆØ¨Ø±
              </option>
              <option value="11">
                Ù†ÙˆÙÙ…Ø¨Ø±
              </option>
              <option value="12">
                Ø¯ÙŠØ³Ù…Ø¨Ø±
              </option>
            </select>
            <button onclick="getMonthly()" class="btn" style="background:#1a237e; margin:0;">
              Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­ØµÙŠÙ„Ø©
            </button>
            <button onclick="window.print()" class="btn" style="background:#2e7d32; margin:0;">
              Ø·Ø¨Ø§Ø¹Ø© (A4 Ø¹Ø±Ø¶ÙŠ)
            </button>
          </div>
        </div>
        <div id="monthly-report-area" class="hidden" style="margin-top: 20px;">
          <div class="print-section" style="border: 2px solid #000; padding: 15px;">
            <h3 id="m-report-title" style="text-align: center; background: #eee; padding: 10px; border: 2px solid #000; margin-bottom: 10px;">
              Ø­ØµÙŠÙ„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ø´Ù‡Ø±: ...
            </h3>
            <table>
              <thead>
                <tr>
                  <th rowspan="2">
                    Ø§Ù„Ø¨ÙŠØ§Ù†
                  </th>
                  <th colspan="4">
                    Ø§Ù„Ø¥Ø³Ø¹Ø§Ù
                  </th>
                  <th colspan="4">
                    Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±
                  </th>
                  <th colspan="4">
                    Ø§Ù„Ø­Ø±Ø§Ø¦Ù‚
                  </th>
                  <th colspan="4">
                    Ù…Ø®ØªÙ„ÙØ©
                  </th>
                  <th rowspan="2">
                    Ø¹ Øª
                  </th>
                </tr>
                <tr style="font-size: 10px; background: #f0f0f0; color: #000;">
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                </tr>
              </thead>
              <tbody id="m-result-body">
              </tbody>
            </table>
          </div>
        </div>
        <div id="unit-notification" class="hidden no-print" style="background:var(--danger); color:white; padding:15px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
          <span>          <i class="fa-solid fa-bell"></i>
          ØªÙ†Ø¨ÙŠÙ‡:
          <span id="notif-text"></span>
</span>
          <button onclick="clearNotif()" style="background:white; color:red; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">
            Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>
        <div id="master-clock-bar" class="internal-clock-bar hidden no-print" style="background:#f8f9fa; border:1px solid #dee2e6; padding:12px 25px; border-radius:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <i class="fa-solid fa-user-gear"></i>
            Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          </div>
          <div id="m-time-box" style="font-weight:900; font-size:20px;">
          </div>
        </div>
        <div id="master-notif-panel" class="hidden no-print" style="background: #fff; border: 2px solid var(--primary); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
          <div style="display: flex; gap: 10px;">
            <select id="notif-target" class="input-field" style="width: 25%;">
            </select>
            <input type="text" id="notif-msg" class="input-field" style="width: 60%;" placeholder="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©..." />
            <button onclick="sendNotif()" class="btn" style="background: var(--primary); width: 15%; margin:0;">
              Ø¥Ø±Ø³Ø§Ù„
            </button>
          </div>
        </div>
        
        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ© ÙÙ‚Ø· -->
        <div id="backup-panel" class="hidden no-print" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fa-solid fa-shield-halved" style="font-size: 24px;"></i>
              <h3 style="margin: 0; font-size: 18px; font-weight: 900;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
            </div>
            <div id="backup-status-indicator" style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; backdrop-filter: blur(10px);">
              <div id="backup-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #4caf50; box-shadow: 0 0 10px #4caf50;"></div>
              <span id="backup-status-text" style="font-size: 13px; font-weight: 700;">Ø¬Ø§Ù‡Ø²</span>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
              <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</div>
              <div id="last-backup-time" style="font-size: 16px; font-weight: 900;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯</div>
              <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">ğŸ’¾ Ø¬Ù‡Ø§Ø² | â˜ï¸ Ø³Ø­Ø§Ø¨Ø©</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
              <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Ø§Ù„Ø­Ø§Ù„Ø©</div>
              <div id="auto-backup-status" style="font-size: 16px; font-weight: 900;">Ù…ÙØ¹Ù‘Ù„</div>
              <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">ğŸšª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
              <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®</div>
              <div id="backup-count" style="font-size: 16px; font-weight: 900;">0</div>
              <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">ğŸ“¦ Ù…Ø­ÙÙˆØ¸Ø©</div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="openBackupManager()" class="btn" style="background: white; color: #667eea; flex: 1; margin: 0; justify-content: center; font-weight: 900;">
              <i class="fa-solid fa-sliders"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            </button>
          </div>
        </div>
        <div id="status-panel" class="hidden no-print" style="background:#fff; border:2px solid var(--primary); padding:15px; margin-bottom:20px; border-radius:15px;">
          <div id="status-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px;">
          </div>
        </div>
        <div id="unit-clock-bar" class="internal-clock-bar no-print" style="background:#f8f9fa; border:1px solid #dee2e6; padding:12px 25px; border-radius:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <i class="fa-solid fa-clock"></i>
            Ø§Ù„ØªÙˆÙ‚ÙŠØª
          </div>
          <div id="u-time-box" style="font-weight:900; font-size:20px;">
          </div>
        </div>
        <div class="no-print" style="text-align:center; margin-bottom: 20px; background: #e3f2fd; padding: 15px; border-radius: 12px;">
          <label style="font-weight: 800; font-size: 18px;">
            Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:
          </label>
          <input type="week" id="week-picker" style="font-family:'Cairo'; padding: 8px;" onchange="changeWeek()" />
        </div>
        <div id="capture-area">
          <div class="print-section">
            <div class="print-header" style="display: grid; grid-template-columns: 1fr 2fr 1fr; align-items: center; text-align: center; border: 2.5px solid #000; padding: 10px; margin-bottom: 10px;">
              <div>
                Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©
                <br />
                Ù„ÙˆÙ„Ø§ÙŠØ© Ø§Ù„ÙˆØ§Ø¯ÙŠ
              </div>
              <div>
                <h2 style="margin:0; font-weight: 900;">
                  Ø­ØµÙŠÙ„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ
                </h2>
                <div><h2 style="margin:0; font-weight: 900;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h2><div id="week-info" style="font-weight:700; color:blue;"></div></div>
                    <div><h2 style="margin:0; font-weight: 500;">Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø§Ø³Ø¨ÙˆØ¹ÙŠØ©</h2><div  id="user-tag" style="font-weight:500; color:blue;"></div></div>
                    <div>Ù…ÙƒØªØ¨ Ø§Ù„Ø§Ø­ØµØ§Ø¡</div>
            </div>
            <table id="daily-table">
              <thead>
                <tr>
                  <th rowspan="2" style="width:12%">
                    Ø§Ù„ØªØ§Ø±ÙŠØ®
                  </th>
                  <th colspan="4">
                    Ø§Ù„Ø¥Ø³Ø¹Ø§Ù
                  </th>
                  <th colspan="4">
                    Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±
                  </th>
                  <th colspan="4">
                    Ø§Ù„Ø­Ø±Ø§Ø¦Ù‚
                  </th>
                  <th colspan="4">
                    Ù…Ø®ØªÙ„ÙØ©
                  </th>
                  <th rowspan="2" style="width:6%">
                    Ø¹ Øª
                  </th>
                </tr>
                <tr class="sub-head">
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                </tr>
              </thead>
              <tbody id="daily-body">
              </tbody>
              <tfoot id="daily-foot" style="background:#e8f5e9; font-weight:900;">
              </tfoot>
            </table>
          </div>
          <div class="print-section">
            <div class="print-header" style="display: grid; grid-template-columns: 1fr 2fr 1fr; align-items: center; text-align: center; border: 2.5px solid #000; padding: 10px; margin-bottom: 10px;">
              <div>
                Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©
                <br />
                ÙˆÙ„Ø§ÙŠØ© Ø§Ù„ÙˆØ§Ø¯ÙŠ
              </div>
              <div><h2 style="margin:0; font-weight: 900;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h2><div id="week-info" style="font-weight:700; color:blue;"></div></div>
                    <div><h2 style="margin:0; font-weight: 500;">Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª</h2><div  id="user-tag" style="font-weight:500; color:blue;"></div></div>
                    <div>Ù…ÙƒØªØ¨ Ø§Ù„Ø§Ø­ØµØ§Ø¡</div>
            </div>
            <table id="muni-table">
              <thead>
                <tr>
                  <th rowspan="2" style="width:15%">
                    Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©
                  </th>
                  <th colspan="4">
                    Ø§Ù„Ø¥Ø³Ø¹Ø§Ù
                  </th>
                  <th colspan="4">
                    Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±
                  </th>
                  <th colspan="4">
                    Ø§Ù„Ø­Ø±Ø§Ø¦Ù‚
                  </th>
                  <th colspan="4">
                    Ù…Ø®ØªÙ„ÙØ©
                  </th>
                  <th rowspan="2" style="width:6%">
                    Ø¹ Øª
                  </th>
                </tr>
                <tr class="sub-head">
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                  <th>
                    Ø¹ Ø¹
                  </th>
                  <th>
                    Ø¹ Øª
                  </th>
                  <th>
                    Ù…Ø³Ø¹Ù
                  </th>
                  <th>
                    ÙˆÙØ§Ø©
                  </th>
                </tr>
              </thead>
              <tbody id="muni-body">
              </tbody>
              <tfoot id="muni-foot" style="background:#fff3e0; font-weight:900;">
              </tfoot>
            </table>
          </div>
        </div>
        <div class="no-print" style="width:100%; height:320px; margin: 20px auto;">
          <canvas id="mainChart">
          </canvas>
        </div>
        <div id="archive-section" class="no-print" style="background:#fff; padding:20px; border-radius:15px; border:2px solid var(--primary); margin-bottom: 80px;">
          
          <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
            <h3 style="margin:0; color:var(--primary); font-weight:900; font-size:20px;">
              <i class="fa-solid fa-box-archive"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø­ØµØ§Ø¦Ù„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
            </h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="setArchiveView('timeline')" id="view-timeline-btn" class="btn" style="background:var(--primary); margin:0; padding:8px 15px; font-size:13px;">
                <i class="fa-solid fa-timeline"></i> Ù…Ø®Ø·Ø· Ø²Ù…Ù†ÙŠ
              </button>
              <button onclick="setArchiveView('compare')" id="view-compare-btn" class="btn" style="background:#607d8b; margin:0; padding:8px 15px; font-size:13px;">
                <i class="fa-solid fa-code-compare"></i> Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†
              </button>
              <button onclick="printArchiveReport()" class="btn" style="background:var(--success); margin:0; padding:8px 15px; font-size:13px;">
                <i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
              </button>
            </div>
          </div>

          <!-- ÙÙ„ØªØ± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
            <div>
              <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">ğŸ“… Ø§Ù„Ø³Ù†Ø©</label>
              <select id="arc-year" class="input-field" onchange="updateMonthFilter()" style="margin:0;">
              </select>
            </div>
            <div>
              <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">ğŸ“† Ø§Ù„Ø´Ù‡Ø±</label>
              <select id="arc-month" class="input-field" onchange="loadArchiveView()" style="margin:0;">
              </select>
            </div>
          </div>

          <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
          <div id="archive-content-area"></div>

          <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (Ù…Ø®ÙÙŠØ© Ø¨Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) -->
          <div id="compare-area" style="display:none; margin-top:20px;">
            <div style="background:#f8f9fa; padding:20px; border-radius:12px; border:2px dashed #607d8b;">
              <h4 style="margin:0 0 15px 0; color:#607d8b; font-weight:900;">
                <i class="fa-solid fa-code-compare"></i> Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†
              </h4>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                  <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</label>
                  <select id="compare-week-1" class="input-field" style="margin:0;"></select>
                </div>
                <div>
                  <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                  <select id="compare-week-2" class="input-field" style="margin:0;"></select>
                </div>
              </div>
              <button onclick="runComparison()" class="btn" style="background:#607d8b; margin:0; width:100%; justify-content:center;">
                <i class="fa-solid fa-magnifying-glass-chart"></i> Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¢Ù†
              </button>
            </div>
            <div id="comparison-result" style="margin-top:15px;"></div>
          </div>

        </div>
        <div id="archive-container"></div>
      </div>
      <div class="no-print" style="text-align:center; padding-bottom: 100px;">
        <button class="btn" style="background:var(--success)" onclick="saveData()">
          <i class="fa-solid fa-floppy-disk"></i>
          Ø­ÙØ¸ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† âœ…
        </button>
        <button class="btn" style="background:#e67e22" onclick="window.print()">
          <i class="fa-solid fa-print"></i>
          Ø·Ø¨Ø§Ø¹Ø©
        </button>
        <button class="btn" style="background:#673ab7" onclick="changeMyPassword()">
          <i class="fa-solid fa-key"></i>
          Ø§Ù„ÙƒÙˆØ¯
        </button>
        <button id="master-reveal-btn" class="btn hidden" style="background:#f57f17" onclick="revealUnitPass()">
          <i class="fa-solid fa-eye"></i>
          ÙƒØ´Ù
        </button>
        <button class="btn" style="background:#546e7a" onclick="location.reload()">
          <i class="fa-solid fa-door-open"></i>
          Ø®Ø±ÙˆØ¬
        </button>
        <div id="monthly-report-section" class="hidden print-section" style="margin-top: 40px; border-top: 4px double #1a237e; padding-top: 20px;">
          <div style="background:#1a237e; color:white; padding:12px; text-align:center; font-weight:900; font-size:22px; border-radius:8px 8px 0 0;">
            <i class="fa-solid fa-calculator"></i>
            Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
          </div>
          <table id="monthly-table">
            <thead>
              <tr>
                <th rowspan="2" style="width:15%">
                  Ø§Ù„Ø¨ÙŠØ§Ù†
                </th>
                <th colspan="4">
                  Ø§Ù„Ø¥Ø³Ø¹Ø§Ù
                </th>
                <th colspan="4">
                  Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±
                </th>
                <th colspan="4">
                  Ø§Ù„Ø­Ø±Ø§Ø¦Ù‚
                </th>
                <th colspan="4">
                  Ù…Ø®ØªÙ„ÙØ©
                </th>
                <th rowspan="2" style="width:6%">
                  Ø¹ Øª
                </th>
              </tr>
              <tr class="sub-head">
                <th>
                  Ø¹ Ø¹
                </th>
                <th>
                  Ø¹ Øª
                </th>
                <th>
                  Ù…Ø³Ø¹Ù
                </th>
                <th>
                  ÙˆÙØ§Ø©
                </th>
                <th>
                  Ø¹ Ø¹
                </th>
                <th>
                  Ø¹ Øª
                </th>
                <th>
                  Ù…Ø³Ø¹Ù
                </th>
                <th>
                  ÙˆÙØ§Ø©
                </th>
                <th>
                  Ø¹ Ø¹
                </th>
                <th>
                  Ø¹ Øª
                </th>
                <th>
                  Ù…Ø³Ø¹Ù
                </th>
                <th>
                  ÙˆÙØ§Ø©
                </th>
                <th>
                  Ø¹ Ø¹
                </th>
                <th>
                  Ø¹ Øª
                </th>
                <th>
                  Ù…Ø³Ø¹Ù
                </th>
                <th>
                  ÙˆÙØ§Ø©
                </th>
              </tr>
            </thead>
            <tbody id="monthly-body" style="background: #fff;">
            </tbody>
          </table>
          <div class="no-print" style="text-align:left; margin-top:10px;">
            <button class="btn" style="background:#d32f2f; padding:5px 15px; font-size:12px;" onclick="document.getElementById('monthly-report-section').classList.add('hidden')">
              Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ã—
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBxYbKWfBM-e2wE1ry_SNDSDaSi2k3IgHY",
  authDomain: "eloued-system.firebaseapp.com",
  projectId: "eloued-system",
  storageBucket: "eloued-system.firebasestorage.app",
  messagingSenderId: "215124234121",
  appId: "1:215124234121:web:01536290ef78a417a71b58"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function checkDatabaseConnection() {
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const loginBtn = document.getElementById('login-btn');
    
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
            // Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­
            statusDot.style.background = '#4caf50';
            statusDot.style.animation = 'none';
            statusDot.style.boxShadow = '0 0 8px #4caf50';
            statusText.innerText = 'Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ“';
            statusText.style.color = '#4caf50';
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<i class="fa-solid fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„';
            loginBtn.style.opacity = '1';
            loginBtn.style.cursor = 'pointer';
        } else {
            // ØºÙŠØ± Ù…ØªØµÙ„
            statusDot.style.background = '#f44336';
            statusDot.style.animation = 'pulse 1s infinite';
            statusDot.style.boxShadow = '0 0 8px #f44336';
            statusText.innerText = 'ØºÙŠØ± Ù…ØªØµÙ„ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª âš ';
            statusText.style.color = '#f44336';
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fa-solid fa-wifi"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„';
            loginBtn.style.opacity = '0.6';
            loginBtn.style.cursor = 'not-allowed';
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ù„Ù…ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·)
            if (currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
                createAutoBackup();
                console.log('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø³Ø¨Ø¨ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
    });
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„
function monitorConnectionInApp() {
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        if (snap.val() === false && currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„
            createAutoBackup();
            
            Swal.fire({
                icon: 'warning',
                title: 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„',
                text: 'ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹',
                timer: 3000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }
    });
}

// ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
setTimeout(checkDatabaseConnection, 500);

let myChart = null;
const unitConfig = {"Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©": [], "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©": ["Ø§Ù„ÙˆØ§Ø¯ÙŠ", "ÙƒÙˆÙŠÙ†ÙŠÙ†"], "Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…ØªÙ‚Ø¯Ù…": ["Ø§Ù„ÙˆØ§Ø¯ÙŠ"], "Ø§Ù„Ø±Ø¨Ø§Ø­": ["Ø§Ù„Ø±Ø¨Ø§Ø­", "Ø§Ù„Ø¨ÙŠØ§Ø¶Ø©", "Ø§Ù„Ù†Ø®Ù„Ø©", "Ø§Ù„Ø¹Ù‚Ù„Ø©"], "Ù…ÙŠÙ‡ ÙˆÙ†Ø³Ø©": ["Ø£Ù…ÙŠÙ‡ ÙˆÙ†Ø³Ø©", "ÙˆØ§Ø¯ Ø§Ù„Ø¹Ù„Ù†Ø¯Ù‡"], "Ù‚Ù…Ø§Ø±": ["Ù‚Ù…Ø§Ø±", "ØªØºØ²ÙˆØª", "ÙˆØ±Ù…Ø§Ø³"], "Ø§Ù„Ø¯Ø¨ÙŠÙ„Ø©": ["Ø§Ù„Ø¯Ø¨ÙŠÙ„Ø©", "Ø­Ø³Ø§Ù†ÙŠ Ø¹Ø¨Ø¯ Ø§Ù„ÙƒØ±ÙŠÙ…", "Ø§Ù„Ø·Ø±ÙŠÙØ§ÙˆÙŠ"], "Ø­Ø§Ø³ÙŠ Ø®Ù„ÙŠÙØ©": ["Ø§Ù„Ø·Ø±ÙŠÙØ§ÙˆÙŠ", "Ø­Ø§Ø³ÙŠ Ø®Ù„ÙŠÙØ©"], "Ø§Ù„Ù…Ù‚Ø±Ù†": ["Ø§Ù„Ù…Ù‚Ø±Ù†", "Ø³ÙŠØ¯ÙŠ Ø¹ÙˆÙ†"], "Ø§Ù„Ø±Ù‚ÙŠØ¨Ø©": ["Ø§Ù„Ø±Ù‚ÙŠØ¨Ø©"], "Ø§Ù„Ø­Ù…Ø±Ø§ÙŠØ©": ["Ø§Ù„Ø­Ù…Ø±Ø§ÙŠØ©"], "Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠ": ["Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠ", "Ø¨Ù† Ù‚Ø´Ø©"], "Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø§Ø¡": ["Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø§Ø¡"]};
let currentUser = ""; let currentWeek = "";

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
let backupTimer = null;
let backupInterval = 5 * 60 * 1000; // 5 Ø¯Ù‚Ø§Ø¦Ù‚
let nextBackupCountdown = null;
let backupCount = 0;

// Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
async function initAutoBackup() {
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø¨Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠ
    await updateBackupCount();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const autoBackupEnabled = localStorage.getItem('auto_backup_enabled') !== 'false';
    
    if (autoBackupEnabled) {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.addEventListener('beforeunload', handleBeforeUnload);
        
        document.getElementById('auto-backup-status').innerText = 'Ù…ÙØ¹Ù‘Ù„';
        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬');
    } else {
        document.getElementById('auto-backup-status').innerText = 'Ù…Ø¹Ø·Ù‘Ù„';
        console.log('â¸ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø¹Ø·Ù‘Ù„');
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
function handleBeforeUnload(e) {
    const autoBackupEnabled = localStorage.getItem('auto_backup_enabled') !== 'false';
    
    if (autoBackupEnabled && currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        createAutoBackup();
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // e.preventDefault();
        // e.returnValue = '';
    }
}

async function createAutoBackup() {
    console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
    
    try {
        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
        console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...');
        const snapshot = await db.ref('data').once('value');
        const allData = snapshot.val() || {};
        console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', Object.keys(allData).length, 'Ø£Ø³Ø¨ÙˆØ¹');
        
        // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹
        const backupData = {
            timestamp: new Date().toISOString(),
            data: allData,
            week: currentWeek,
            user: currentUser
        };
        
        // 1ï¸âƒ£ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² (localStorage)
        console.log('ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ...');
        localStorage.setItem('auto_backup_latest', JSON.stringify(backupData));
        console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
        
        // Ø­ÙØ¸ Ù†Ø³Ø® Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¢Ø®Ø± 10 Ù†Ø³Ø®)
        let localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
        localBackups.unshift(backupData);
        localBackups = localBackups.slice(0, 10); // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 10 Ù†Ø³Ø® ÙÙ‚Ø·
        localStorage.setItem('auto_backups', JSON.stringify(localBackups));
        console.log('ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', localBackups.length);
        
        // 2ï¸âƒ£ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙÙŠ Firebase
        console.log('â˜ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ...');
        const timestamp = new Date().getTime();
        const backupKey = `backup_${timestamp}`;
        
        // Ø­ÙØ¸ ÙÙŠ Ù‚Ø³Ù… Ø®Ø§Øµ Ø¨Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        await db.ref('backups/' + backupKey).set({
            timestamp: backupData.timestamp,
            data: allData,
            week: currentWeek,
            user: currentUser,
            backupType: 'auto'
        });
        console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ù…ÙØªØ§Ø­:', backupKey);
        
        // Ø­ÙØ¸ Ù…Ø±Ø¬Ø¹ Ù„Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        await db.ref('backups/latest').set({
            timestamp: backupData.timestamp,
            backupKey: backupKey,
            week: currentWeek
        });
        
        // Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Firebase (Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 10 ÙÙ‚Ø·)
        const allBackupsSnapshot = await db.ref('backups').once('value');
        const allBackups = allBackupsSnapshot.val() || {};
        const backupKeys = Object.keys(allBackups).filter(k => k.startsWith('backup_')).sort().reverse();
        
        console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:', backupKeys.length);
        
        if (backupKeys.length > 10) {
            const oldBackups = backupKeys.slice(10);
            console.log('ğŸ—‘ï¸ Ø­Ø°Ù', oldBackups.length, 'Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø©');
            for (let oldKey of oldBackups) {
                await db.ref('backups/' + oldKey).remove();
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠ (Ù…Ø­Ù„ÙŠ + Ø³Ø­Ø§Ø¨ÙŠ)
        updateBackupCount();
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ar-DZ', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('last-backup-time').innerText = timeStr;
        
        // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ø¬Ø§Ø­
        showBackupSuccess('ØªÙ… Ø§Ù„Ø­ÙØ¸ (Ø¬Ù‡Ø§Ø² + Ø³Ø­Ø§Ø¨Ø©)');
        console.log('ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
        
        // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØŒ Ù†Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
        try {
            console.log('âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·...');
            const snapshot = await db.ref('data').once('value');
            const allData = snapshot.val() || {};
            
            const backupData = {
                timestamp: new Date().toISOString(),
                data: allData,
                week: currentWeek,
                user: currentUser
            };
            
            localStorage.setItem('auto_backup_latest', JSON.stringify(backupData));
            
            let localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
            localBackups.unshift(backupData);
            localBackups = localBackups.slice(0, 10);
            localStorage.setItem('auto_backups', JSON.stringify(localBackups));
            
            updateBackupCount();
            showBackupSuccess('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·');
            console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­ (ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ)');
        } catch (e) {
            console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ØªÙ…Ø§Ù…Ø§Ù‹:', e);
            showBackupError();
        }
    }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
async function updateBackupCount() {
    try {
        // Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
        const localCount = localBackups.length;
        
        // Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
        let cloudCount = 0;
        try {
            const snapshot = await db.ref('backups').once('value');
            const allBackups = snapshot.val() || {};
            const backupKeys = Object.keys(allBackups).filter(k => k.startsWith('backup_'));
            cloudCount = backupKeys.length;
        } catch (error) {
            console.log('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©');
        }
        
        // Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        const totalCount = localCount + cloudCount;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        document.getElementById('backup-count').innerHTML = `
            <div style="font-size: 16px; font-weight: 900;">${totalCount}</div>
            <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ğŸ’¾ ${localCount} | â˜ï¸ ${cloudCount}</div>
        `;
        
        console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø®: ${totalCount} (Ù…Ø­Ù„ÙŠ: ${localCount}, Ø³Ø­Ø§Ø¨ÙŠ: ${cloudCount})`);
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®:', error);
    }
}

function createManualBackup() {
    const statusText = document.getElementById('backup-status-text');
    const statusDot = document.getElementById('backup-dot');
    
    statusText.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    statusDot.style.background = '#ffc107';
    
    createAutoBackup();
    
    Swal.fire({
        icon: 'success',
        title: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
        text: 'ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­',
        timer: 2000,
        showConfirmButton: false
    });
}

async function restoreFromBackup() {
    // Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
    const result = await Swal.fire({
        title: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        html: `
            <div style="font-family: Cairo; text-align: right;">
                <p style="font-size: 16px; margin-bottom: 20px;">Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:</p>
            </div>
        `,
        icon: 'question',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'ğŸ’¾ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²',
        denyButtonText: 'â˜ï¸ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmButtonColor: '#2196f3',
        denyButtonColor: '#4caf50',
        cancelButtonColor: '#9e9e9e'
    });
    
    if (result.isConfirmed) {
        // Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        await restoreFromLocalBackup();
    } else if (result.isDenied) {
        // Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
        await restoreFromCloudBackup();
    }
}

async function restoreFromLocalBackup() {
    try {
        const backup = localStorage.getItem('auto_backup_latest');
        
        if (!backup) {
            Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ©', 'info');
            return;
        }
        
        const backupData = JSON.parse(backup);
        const backupTime = new Date(backupData.timestamp).toLocaleString('ar-DZ');
        
        const confirm = await Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²',
            html: `
                <div style="text-align: right; font-family: Cairo;">
                    <p><strong>ğŸ“ Ø§Ù„Ù…ØµØ¯Ø±:</strong> Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²</p>
                    <p><strong>ğŸ• ÙˆÙ‚Øª Ø§Ù„Ù†Ø³Ø®Ø©:</strong> ${backupTime}</p>
                    <p><strong>ğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</strong> ${backupData.week}</p>
                    <p style="color: #d32f2f; font-weight: 700; margin-top: 15px;">âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            confirmButtonColor: '#ff9800'
        });
        
        if (confirm.isConfirmed) {
            Swal.fire({
                title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©...',
                text: 'ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase
            await db.ref('data').set(backupData.data);
            
            Swal.fire({
                icon: 'success',
                title: 'ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­',
                text: 'ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ±ÙØ¹Ù‡Ø§ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©',
                confirmButtonColor: '#4caf50'
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            renderSystem();
        }
        
    } catch (error) {
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²', 'error');
        console.error(error);
    }
}

async function restoreFromCloudBackup() {
    try {
        Swal.fire({
            title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...',
            text: 'ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Firebase
        const backupsSnapshot = await db.ref('backups').once('value');
        const allBackups = backupsSnapshot.val() || {};
        
        const backupKeys = Object.keys(allBackups).filter(k => k.startsWith('backup_')).sort().reverse();
        
        if (backupKeys.length === 0) {
            Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'info');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        let optionsHtml = '<div style="max-height: 400px; overflow-y: auto; text-align: right; font-family: Cairo;">';
        
        for (let i = 0; i < Math.min(backupKeys.length, 10); i++) {
            const key = backupKeys[i];
            const backup = allBackups[key];
            const backupTime = new Date(backup.timestamp).toLocaleString('ar-DZ');
            const isLatest = i === 0 ? ' ğŸŸ¢ (Ø§Ù„Ø£Ø­Ø¯Ø«)' : '';
            
            optionsHtml += `
                <div class="backup-option" data-key="${key}" style="
                    border: 2px solid #e0e0e0;
                    padding: 15px;
                    margin-bottom: 10px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s;
                " onmouseover="this.style.borderColor='#4caf50'; this.style.background='#f1f8f4';" 
                   onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white';"
                   onclick="selectBackupForRestore('${key}')">
                    <div style="font-weight: 700; color: #1a237e; margin-bottom: 5px;">
                        Ù†Ø³Ø®Ø© ${i + 1}${isLatest}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ğŸ• ${backupTime}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${backup.week}
                    </div>
                </div>
            `;
        }
        
        optionsHtml += '</div>';
        
        Swal.fire({
            title: 'Ø§Ø®ØªØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
            html: optionsHtml,
            width: '600px',
            showCancelButton: true,
            showConfirmButton: false,
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        });
        
    } catch (error) {
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'error');
        console.error(error);
    }
}

async function selectBackupForRestore(backupKey) {
    try {
        Swal.fire({
            title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        const backupSnapshot = await db.ref('backups/' + backupKey).once('value');
        const backup = backupSnapshot.val();
        
        if (!backup) {
            Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
            return;
        }
        
        const backupTime = new Date(backup.timestamp).toLocaleString('ar-DZ');
        
        const confirm = await Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©',
            html: `
                <div style="text-align: right; font-family: Cairo;">
                    <p><strong>â˜ï¸ Ø§Ù„Ù…ØµØ¯Ø±:</strong> Ù†Ø³Ø®Ø© Ø³Ø­Ø§Ø¨ÙŠØ© ÙÙŠ Firebase</p>
                    <p><strong>ğŸ• ÙˆÙ‚Øª Ø§Ù„Ù†Ø³Ø®Ø©:</strong> ${backupTime}</p>
                    <p><strong>ğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</strong> ${backup.week}</p>
                    <p style="color: #d32f2f; font-weight: 700; margin-top: 15px;">âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            confirmButtonColor: '#4caf50'
        });
        
        if (confirm.isConfirmed) {
            Swal.fire({
                title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.ref('data').set(backup.data);
            
            Swal.fire({
                icon: 'success',
                title: 'ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­',
                text: 'ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©',
                confirmButtonColor: '#4caf50'
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            renderSystem();
        }
        
    } catch (error) {
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'error');
        console.error(error);
    }
}

function downloadBackup() {
    try {
        const backup = localStorage.getItem('auto_backup_latest');
        
        if (!backup) {
            Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„ØªÙ†Ø²ÙŠÙ„', 'info');
            return;
        }
        
        const backupData = JSON.parse(backup);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `backup_${timestamp}.json`;
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù„Ù„ØªÙ†Ø²ÙŠÙ„
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        
        Swal.fire({
            icon: 'success',
            title: 'ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„',
            text: 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
            timer: 2000,
            showConfirmButton: false
        });
        
    } catch (error) {
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
        console.error(error);
    }
}

function showBackupSuccess(message = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“') {
    const statusDot = document.getElementById('backup-dot');
    const statusText = document.getElementById('backup-status-text');
    
    statusDot.style.background = '#4caf50';
    statusDot.style.animation = 'pulse 0.5s';
    statusText.innerText = message;
    
    setTimeout(() => {
        statusDot.style.animation = '';
        statusText.innerText = 'Ø¬Ø§Ù‡Ø²';
    }, 3000);
}

function showBackupError() {
    const statusDot = document.getElementById('backup-dot');
    const statusText = document.getElementById('backup-status-text');
    
    statusDot.style.background = '#f44336';
    statusText.innerText = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸';
    
    setTimeout(() => {
        statusDot.style.background = '#4caf50';
        statusText.innerText = 'Ø¬Ø§Ù‡Ø²';
    }, 3000);
}

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
async function openBackupManager() {
    // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    const localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
    let cloudBackups = [];
    try {
        const snapshot = await db.ref('backups').once('value');
        const allBackups = snapshot.val() || {};
        const backupKeys = Object.keys(allBackups).filter(k => k.startsWith('backup_')).sort().reverse();
        
        cloudBackups = backupKeys.map(key => ({
            key: key,
            ...allBackups[key]
        }));
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:', error);
    }
    
    // Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const autoBackupEnabled = localStorage.getItem('auto_backup_enabled') !== 'false';
    
    // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modalHtml = `
        <div style="font-family: Cairo; text-align: right;">
            <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
            <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                <button id="tab-settings" onclick="switchBackupTab('settings')" style="
                    flex: 1;
                    padding: 15px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-bottom: 3px solid #667eea;
                    cursor: pointer;
                    font-family: Cairo;
                    font-weight: 700;
                    font-size: 16px;
                    transition: 0.3s;
                ">
                    âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ…
                </button>
                <button id="tab-local" onclick="switchBackupTab('local')" style="
                    flex: 1;
                    padding: 15px;
                    background: #f5f5f5;
                    color: #666;
                    border: none;
                    border-bottom: 3px solid transparent;
                    cursor: pointer;
                    font-family: Cairo;
                    font-weight: 700;
                    font-size: 16px;
                    transition: 0.3s;
                ">
                    ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ© (${localBackups.length})
                </button>
                <button id="tab-cloud" onclick="switchBackupTab('cloud')" style="
                    flex: 1;
                    padding: 15px;
                    background: #f5f5f5;
                    color: #666;
                    border: none;
                    border-bottom: 3px solid transparent;
                    cursor: pointer;
                    font-family: Cairo;
                    font-weight: 700;
                    font-size: 16px;
                    transition: 0.3s;
                ">
                    â˜ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (${cloudBackups.length})
                </button>
            </div>
            
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ… -->
            <div id="content-settings" style="max-height: 500px; overflow-y: auto;">
                <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #667eea; font-size: 18px;">
                                <i class="fa-solid fa-door-open"></i> Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
                            </h3>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ùˆ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
                            </p>
                        </div>
                        <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="auto-backup-toggle" ${autoBackupEnabled ? 'checked' : ''} 
                                   onchange="toggleAutoBackup(this.checked)" 
                                   style="opacity: 0; width: 0; height: 0;">
                            <span style="
                                position: absolute;
                                cursor: pointer;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background-color: ${autoBackupEnabled ? '#4caf50' : '#ccc'};
                                transition: 0.4s;
                                border-radius: 34px;
                            ">
                                <span style="
                                    position: absolute;
                                    content: '';
                                    height: 26px;
                                    width: 26px;
                                    left: ${autoBackupEnabled ? '30px' : '4px'};
                                    bottom: 4px;
                                    background-color: white;
                                    transition: 0.4s;
                                    border-radius: 50%;
                                "></span>
                            </span>
                        </label>
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ø¶Ù…Ø§Ù† Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
                    </div>
                </div>
                
                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <button onclick="createManualBackupFromModal()" style="
                        padding: 20px;
                        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        font-family: Cairo;
                        font-weight: 900;
                        font-size: 16px;
                        transition: 0.3s;
                        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76, 175, 80, 0.4)';"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(76, 175, 80, 0.3)';">
                        <i class="fa-solid fa-download" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                        Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø¢Ù†
                    </button>
                    
                    <button onclick="quickRestore()" style="
                        padding: 20px;
                        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        font-family: Cairo;
                        font-weight: 900;
                        font-size: 16px;
                        transition: 0.3s;
                        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 152, 0, 0.4)';"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 152, 0, 0.3)';">
                        <i class="fa-solid fa-clock-rotate-left" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                        Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø©
                    </button>
                    
                    <button onclick="downloadLatestBackup()" style="
                        padding: 20px;
                        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        font-family: Cairo;
                        font-weight: 900;
                        font-size: 16px;
                        transition: 0.3s;
                        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.4)';"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)';">
                        <i class="fa-solid fa-file-export" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                        ØªÙ†Ø²ÙŠÙ„ Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
                    </button>
                    
                    <button onclick="uploadBackupFile()" style="
                        padding: 20px;
                        background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        font-family: Cairo;
                        font-weight: 900;
                        font-size: 16px;
                        transition: 0.3s;
                        box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(156, 39, 176, 0.4)';"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(156, 39, 176, 0.3)';">
                        <i class="fa-solid fa-file-import" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                        Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø®Ø§Ø±Ø¬ÙŠØ©
                    </button>
                </div>
            </div>
            
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ© -->`
            + generateBackupListHTML(localBackups, 'local') + `
            
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© -->`
            + generateBackupListHTML(cloudBackups, 'cloud') + `
        </div>
    `;
    
    Swal.fire({
        title: '<div style="font-family: Cairo; font-weight: 900; color: #1a237e;"><i class="fa-solid fa-shield-halved"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</div>',
        html: modalHtml,
        width: '900px',
        showCloseButton: true,
        showConfirmButton: false,
        customClass: {
            container: 'backup-manager-modal'
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø®
function generateBackupListHTML(backups, type) {
    const isLocal = type === 'local';
    const displayStyle = type === 'settings' ? 'block' : 'none';
    
    return `
        <div id="content-${type}" style="max-height: 500px; overflow-y: auto; display: ${displayStyle};">
            ${backups.length === 0 ? `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fa-solid fa-${isLocal ? 'folder-open' : 'cloud'}" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p style="font-size: 16px; font-weight: 700;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® ${isLocal ? 'Ù…Ø­Ù„ÙŠØ©' : 'Ø³Ø­Ø§Ø¨ÙŠØ©'}</p>
                </div>
            ` : backups.map((backup, index) => {
                const backupTime = new Date(backup.timestamp).toLocaleString('ar-DZ');
                const backupKey = isLocal ? index : backup.key;
                return `
                    <div style="
                        border: 2px solid #e0e0e0;
                        padding: 15px;
                        margin-bottom: 10px;
                        border-radius: 12px;
                        background: white;
                        transition: 0.3s;
                    " onmouseover="this.style.borderColor='${isLocal ? '#667eea' : '#4caf50'}'; this.style.background='${isLocal ? '#f8f9ff' : '#f1f8f4'}';" 
                       onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white';">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 900; font-size: 16px; color: ${isLocal ? '#667eea' : '#4caf50'}; margin-bottom: 8px;">
                                    ${index === 0 ? 'ğŸŸ¢ ' : ''}Ù†Ø³Ø®Ø© ${isLocal ? 'Ù…Ø­Ù„ÙŠØ©' : 'Ø³Ø­Ø§Ø¨ÙŠØ©'} #${index + 1}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                                    <i class="fa-solid fa-clock"></i> ${backupTime}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                                    <i class="fa-solid fa-calendar"></i> Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${backup.week}
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    <i class="fa-solid fa-user"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${backup.user}
                                </div>
                                ${!isLocal ? `<div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    <i class="fa-solid fa-key"></i> ${backup.key}
                                </div>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button onclick="restoreSingle${isLocal ? 'Local' : 'Cloud'}Backup(${isLocal ? index : "'" + backupKey + "'" })" style="
                                    padding: 8px 15px;
                                    background: #4caf50;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-family: Cairo;
                                    font-weight: 700;
                                    font-size: 13px;
                                    white-space: nowrap;
                                ">
                                    <i class="fa-solid fa-upload"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                                </button>
                                <button onclick="deleteSingle${isLocal ? 'Local' : 'Cloud'}Backup(${isLocal ? index : "'" + backupKey + "'" })" style="
                                    padding: 8px 15px;
                                    background: #f44336;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-family: Cairo;
                                    font-weight: 700;
                                    font-size: 13px;
                                    white-space: nowrap;
                                ">
                                    <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
            
            ${backups.length > 0 ? `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <button onclick="deleteAll${isLocal ? 'Local' : 'Cloud'}Backups()" style="
                        width: 100%;
                        padding: 15px;
                        background: ${isLocal ? '#d32f2f' : '#c62828'};
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-family: Cairo;
                        font-weight: 900;
                        font-size: 16px;
                    ">
                        <i class="fa-solid fa-trash-can"></i> Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® ${isLocal ? 'Ø§Ù„Ù…Ø­Ù„ÙŠØ©' : 'Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©'} (${backups.length})
                    </button>
                </div>
            ` : ''}
        </div>
    `;
}

// Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
function switchBackupTab(tab) {
    const tabs = ['settings', 'local', 'cloud'];
    const colors = {
        'settings': '#667eea',
        'local': '#667eea',
        'cloud': '#4caf50'
    };
    
    tabs.forEach(t => {
        const tabBtn = document.getElementById(`tab-${t}`);
        const content = document.getElementById(`content-${t}`);
        
        if (t === tab) {
            tabBtn.style.background = colors[t];
            tabBtn.style.color = 'white';
            tabBtn.style.borderBottom = `3px solid ${colors[t]}`;
            content.style.display = 'block';
        } else {
            tabBtn.style.background = '#f5f5f5';
            tabBtn.style.color = '#666';
            tabBtn.style.borderBottom = '3px solid transparent';
            content.style.display = 'none';
        }
    });
}

// ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
function toggleAutoBackup(enabled) {
    localStorage.setItem('auto_backup_enabled', enabled);
    
    if (enabled) {
        document.getElementById('auto-backup-status').innerText = 'Ù…ÙØ¹Ù‘Ù„';
        Swal.fire({
            icon: 'success',
            title: 'ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„',
            text: 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    } else {
        document.getElementById('auto-backup-status').innerText = 'Ù…Ø¹Ø·Ù‘Ù„';
        Swal.fire({
            icon: 'info',
            title: 'ØªÙ… Ø§Ù„ØªØ¹Ø·ÙŠÙ„',
            text: 'Ù„Ù† ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
async function createManualBackupFromModal() {
    await createManualBackup();
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    setTimeout(() => openBackupManager(), 1000);
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø©
async function quickRestore() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
    try {
        const snapshot = await db.ref('backups').once('value');
        const allBackups = snapshot.val() || {};
        const backupKeys = Object.keys(allBackups).filter(k => k.startsWith('backup_')).sort().reverse();
        
        if (backupKeys.length > 0) {
            await restoreSingleCloudBackup(backupKeys[0]);
            return;
        }
    } catch (error) {
        console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø³Ø­Ø§Ø¨ÙŠØ©ØŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ');
    }
    
    // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ
    const localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
    if (localBackups.length > 0) {
        await restoreSingleLocalBackup(0);
    } else {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…ØªØ§Ø­Ø©', 'info');
    }
}

// ØªÙ†Ø²ÙŠÙ„ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø©
function downloadLatestBackup() {
    const backup = localStorage.getItem('auto_backup_latest');
    
    if (!backup) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„ØªÙ†Ø²ÙŠÙ„', 'info');
        return;
    }
    
    const backupData = JSON.parse(backup);
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `backup_${timestamp}.json`;
    
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    
    Swal.fire({
        icon: 'success',
        title: 'ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„',
        text: 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
        timer: 2000,
        showConfirmButton: false
    });
}

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø®Ø§Ø±Ø¬ÙŠØ©
function uploadBackupFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const backupData = JSON.parse(text);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!backupData.data || !backupData.timestamp) {
                Swal.fire('Ø®Ø·Ø£', 'Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
                return;
            }
            
            const result = await Swal.fire({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
                html: `<div style="font-family: Cairo; text-align: right;">
                    <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ</p>
                    <p style="color: #666;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(backupData.timestamp).toLocaleString('ar-DZ')}</p>
                    <p style="color: #d32f2f; font-weight: 700;">âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                </div>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø©',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                confirmButtonColor: '#4caf50'
            });
            
            if (result.isConfirmed) {
                await db.ref('data').set(backupData.data);
                
                // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
                let localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
                localBackups.unshift(backupData);
                localBackups = localBackups.slice(0, 10);
                localStorage.setItem('auto_backups', JSON.stringify(localBackups));
                
                Swal.fire('Ù†Ø¬Ø­', 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                renderSystem();
                openBackupManager();
            }
            
        } catch (error) {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message, 'error');
        }
    };
    
    input.click();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
async function restoreSingleLocalBackup(index) {
    const localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
    const backup = localBackups[index];
    
    if (!backup) {
        Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø³Ø®Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
        return;
    }
    
    const result = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
        html: `<div style="font-family: Cairo; text-align: right;">
            <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©ØŸ</p>
            <p style="color: #d32f2f; font-weight: 700;">âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
        </div>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmButtonColor: '#4caf50'
    });
    
    if (result.isConfirmed) {
        try {
            await db.ref('data').set(backup.data);
            Swal.fire('Ù†Ø¬Ø­', 'ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            renderSystem();
        } catch (error) {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'error');
        }
    }
}

// Ø­Ø°Ù Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
async function deleteSingleLocalBackup(index) {
    const result = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©ØŸ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmButtonColor: '#f44336'
    });
    
    if (result.isConfirmed) {
        let localBackups = JSON.parse(localStorage.getItem('auto_backups') || '[]');
        localBackups.splice(index, 1);
        localStorage.setItem('auto_backups', JSON.stringify(localBackups));
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        await updateBackupCount();
        
        Swal.fire('ØªÙ…', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø©', 'success');
        openBackupManager(); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
    }
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø³Ø­Ø§Ø¨ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
async function restoreSingleCloudBackup(backupKey) {
    try {
        const snapshot = await db.ref('backups/' + backupKey).once('value');
        const backup = snapshot.val();
        
        if (!backup) {
            Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø³Ø®Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
            return;
        }
        
        const result = await Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            html: `<div style="font-family: Cairo; text-align: right;">
                <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŸ</p>
                <p style="color: #d32f2f; font-weight: 700;">âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
            </div>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            confirmButtonColor: '#4caf50'
        });
        
        if (result.isConfirmed) {
            await db.ref('data').set(backup.data);
            Swal.fire('Ù†Ø¬Ø­', 'ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            renderSystem();
        }
    } catch (error) {
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'error');
    }
}

// Ø­Ø°Ù Ù†Ø³Ø®Ø© Ø³Ø­Ø§Ø¨ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
async function deleteSingleCloudBackup(backupKey) {
    const result = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŸ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmButtonColor: '#f44336'
    });
    
    if (result.isConfirmed) {
        try {
            await db.ref('backups/' + backupKey).remove();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            await updateBackupCount();
            
            Swal.fire('ØªÙ…', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'success');
            openBackupManager(); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
        } catch (error) {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
        }
    }
}

// Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ©
async function deleteAllLocalBackups() {
    const result = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙƒÙ„',
        html: `<div style="font-family: Cairo; text-align: right;">
            <p style="font-size: 16px; color: #d32f2f; font-weight: 700;">âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
            <p>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</p>
        </div>`,
        icon: 'error',
        showCancelButton: true,
        confirmButtonText: 'Ø­Ø°Ù Ø§Ù„ÙƒÙ„',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmButtonColor: '#d32f2f'
    });
    
    if (result.isConfirmed) {
        localStorage.removeItem('auto_backups');
        localStorage.removeItem('auto_backup_latest');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        await updateBackupCount();
        
        Swal.fire('ØªÙ…', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'success');
        openBackupManager();
    }
}

// Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
async function deleteAllCloudBackups() {
    const result = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©',
        html: `<div style="font-family: Cairo; text-align: right;">
            <p style="font-size: 16px; color: #c62828; font-weight: 700;">â›” ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±!</p>
            <p>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            <p style="color: #d32f2f; font-weight: 700;">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!</p>
        </div>`,
        icon: 'error',
        showCancelButton: true,
        confirmButtonText: 'Ø­Ø°Ù Ø§Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmButtonColor: '#c62828'
    });
    
    if (result.isConfirmed) {
        try {
            await db.ref('backups').remove();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            await updateBackupCount();
            
            Swal.fire('ØªÙ…', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'success');
            openBackupManager();
        } catch (error) {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
        }
    }
}

window.onload = function() {
    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø§Ù„Ø£Ø­Ø¯ - Ø§Ù„Ø³Ø¨Øª) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    function getAutoPreviousWeek() {
        const now = new Date();
        // Ø·Ø±Ø­ 7 Ø£ÙŠØ§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ
        const pastDate = new Date(now.getTime());
        pastDate.setDate(now.getDate() - 7);
        
        const year = pastDate.getFullYear();
        const firstDayOfYear = new Date(year, 0, 1);
        
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠØ©
        const days = Math.floor((pastDate - firstDayOfYear) / (24 * 60 * 60 * 1000));
        
        // Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø­Ø¯ ÙƒØ£ÙˆÙ„ ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)
        const weekNumber = Math.ceil((days + firstDayOfYear.getDay() + 1) / 7);
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„ØªÙƒÙˆÙ† YYYY-Www (Ù…Ø«Ù„Ø§Ù‹ 2026-W08)
        return year + "-W" + (weekNumber < 10 ? "0" + weekNumber : weekNumber);
    }

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙŠØ¯ÙˆÙŠ
    currentWeek = getAutoPreviousWeek(); 
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    document.getElementById("week-picker").value = currentWeek;
    
    const userSelect = document.getElementById("user-role");
    const notifTarget = document.getElementById("notif-target");
    
    Object.keys(unitConfig).forEach(u => {
        userSelect.innerHTML += `<option value="${u}">${u}</option>`;
        if(u !== "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") notifTarget.innerHTML += `<option value="${u}">${u}</option>`;
    });

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    setInterval(updateClock, 1000);
    updateTicker(); 
    loadArchive();
};
async function login(){
    let p = document.getElementById("pass-code").value; 
    let u = document.getElementById("user-role").value;
    
    if(!p) {
        Swal.fire({
            icon: 'warning',
            title: 'ØªÙ†Ø¨ÙŠÙ‡',
            text: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
            timer: 2000,
            showConfirmButton: false
        });
        return;
    }
    
    // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„
    const loginBtn = document.getElementById('login-btn');
    const originalBtnContent = loginBtn.innerHTML;
    loginBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
    loginBtn.disabled = true;
    
    // Ø¬Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù†Ø³ØªØ®Ø¯Ù… localStorage Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    const snapshot = await db.ref('passwords/' + u).once('value');
    const cloudPass = snapshot.val() || localStorage.getItem("pass_" + u) || "1111";

    if(p !== cloudPass) {
        loginBtn.innerHTML = originalBtnContent;
        loginBtn.disabled = false;
        
        // ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„ÙƒØ§Ø±Øª Ø¹Ù†Ø¯ Ø®Ø·Ø£ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const loginCard = document.querySelector('.login-card');
        loginCard.style.animation = 'shake 0.5s';
        setTimeout(() => loginCard.style.animation = '', 500);
        
        return Swal.fire({
            icon: "error",
            title: "Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
            text: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰",
            confirmButtonColor: '#d32f2f'
        });
    }
    
    currentUser = u;
    currentWeek = document.getElementById("week-picker").value;
    
    // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø¬Ù…ÙŠÙ„Ø©
    Swal.fire({
        icon: 'success',
        title: `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹`,
        html: `<div style="font-size: 18px; font-weight: 700;">
                  ${currentUser}
               </div>`,
        timer: 1500,
        showConfirmButton: false,
        timerProgressBar: true
    });
    
    document.getElementById("login-page").classList.add("hidden");
    document.getElementById("app-content").classList.remove("hidden");
    document.getElementById("user-tag").innerText = "Ø§Ù„ÙˆØ­Ø¯Ø©: " + currentUser;
    
    if(currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
        document.getElementById("status-panel").classList.remove("hidden");
        document.getElementById("master-clock-bar").classList.remove("hidden");
        document.getElementById("master-notif-panel").classList.remove("hidden");
        document.getElementById("backup-panel").classList.remove("hidden");
        document.getElementById("unit-clock-bar").classList.add("hidden");
        document.getElementById("master-reveal-btn").classList.remove("hidden");
        updateStatusPanel();
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        initAutoBackup();
    } else { 
        checkNotifications(); 
    }
    renderSystem();
    
    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    monitorConnectionInApp();
    
    // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠÙˆØ¶Ø¹ Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© login Ù„ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø²Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
const monthlyBtn = document.getElementById('main-monthly-btn');
if (monthlyBtn) {
    if (currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
        monthlyBtn.innerHTML = `<i class="fa-solid fa-chart-line"></i> Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ÙˆÙ„Ø§ÙŠØ©`;
    } else {
        monthlyBtn.innerHTML = `<i class="fa-solid fa-calendar-check"></i> Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ`;
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
loadArchive();
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
async function saveData(){
    let w = document.getElementById("week-picker").value;
    let daily = []; 
    document.querySelectorAll(".d-input").forEach(el => { 
        if(!daily[el.dataset.day]) daily[el.dataset.day] = new Array(16).fill(0); 
        daily[el.dataset.day][el.dataset.col] = el.value; 
    });
    
    let muni = {}; 
    document.querySelectorAll(".m-input").forEach(el => { 
        if(!muni[el.dataset.muni]) muni[el.dataset.muni] = new Array(16).fill(0); 
        muni[el.dataset.muni][el.dataset.col] = el.value; 
    });

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    try {
        await db.ref('data/' + w + '/' + currentUser).set({ daily, muni });
        localStorage.setItem(w + "_daily_" + currentUser, JSON.stringify(daily));
        localStorage.setItem(w + "_muni_" + currentUser, JSON.stringify(muni));
        Swal.fire("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† Ù…ØªÙˆÙØ±Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†", "success");
        updateStatusPanel(); updateTicker(); loadArchive();
    } catch(e) {
        Swal.fire("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸", e.message, "error");
    }
}

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
async function renderSystem(){
    let days = getWeekDays(currentWeek);
    document.getElementById("week-info").innerText = `Ù…Ù† Ø§Ù„Ø£Ø­Ø¯ ${days[0]} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¨Øª ${days[6]}`;
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
    const snapshot = await db.ref('data/' + currentWeek).once('value');
    const cloudData = snapshot.val() || {};

    let dBody = document.getElementById("daily-body"); dBody.innerHTML = "";
    for(let i=0; i<7; i++){
        let data = getUnitDataLocal(currentWeek, i, "daily", cloudData);
        let tr = `<tr><td style="font-weight:900; background:#f9f9f9;">${days[i]}</td>`;
        for(let j=0; j<16; j++){
            // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ d-val Ù„Ù„ØªÙ…ÙƒÙ† Ù…Ù† Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ù„Ù…ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            if(currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") tr += `<td class="d-val" data-day="${i}" data-col="${j}" style="font-weight:800;">${data[j]}</td>`;
            else tr += `<td><input type="number" class="editable d-input" data-day="${i}" data-col="${j}" value="${data[j]}" oninput="calculate()"></td>`;
        }
        tr += `<td style="background:#fff3e0; font-weight:900;" class="d-row-total">0</td></tr>`; dBody.innerHTML += tr;
    }

    let mBody = document.getElementById("muni-body"); mBody.innerHTML = "";
    let munis = (currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") ? getAllMunis() : unitConfig[currentUser];
    munis.forEach(m => {
        let data = getUnitDataLocal(currentWeek, m, "muni", cloudData);
        let tr = `<tr><td style="font-weight:900; background:#f5f5f5;">${m}</td>`;
        for(let j=0; j<16; j++){
            if(currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") tr += `<td class="m-val" data-muni="${m}" data-col="${j}" style="font-weight:800;">${data[j]}</td>`;
            else tr += `<td><input type="number" class="editable m-input" data-muni="${m}" data-col="${j}" value="${data[j]}" oninput="calculate()"></td>`;
        }
        tr += `<td style="background:#fff3e0; font-weight:900;" class="m-row-total">0</td></tr>`; mBody.innerHTML += tr;
    });
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    calculate();
}

function getUnitDataLocal(week, key, type, cloudData) {
    let res = new Array(16).fill(0);
    if(currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
        Object.keys(unitConfig).forEach(u => {
            if(u === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") return;
            let uData = cloudData[u] ? cloudData[u][type] : null;
            if(uData) { let d = uData[key]; if(d) d.forEach((v, i) => res[i] += parseInt(v) || 0); }
        });
    } else {
        let uData = cloudData[currentUser] ? cloudData[currentUser][type] : null;
        if(uData) res = uData[key] || res;
    }
    return res;
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹
function updateClock() { const now = new Date(); const timeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0') + ":" + now.getSeconds().toString().padStart(2,'0'); const dateStr = now.toLocaleDateString('ar-DZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('live-clock').innerText = timeStr; document.getElementById('live-date').innerText = dateStr; if(document.getElementById('u-time-box')) document.getElementById('u-time-box').innerText = timeStr + " | " + dateStr; if(document.getElementById('m-time-box')) document.getElementById('m-time-box').innerText = timeStr + " | " + dateStr; }
function calculate() {
    // 1. Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
    let dTotals = new Array(16).fill(0); 
    
    document.querySelectorAll("#daily-body tr").forEach(row => {
        let rSum = 0;
        // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† input (Ù„Ù„ÙˆØ­Ø¯Ø§Øª) Ø£Ùˆ Ù…Ù† td.d-val (Ù„Ù„Ù…ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
        let values = row.querySelectorAll(".d-input, .d-val");
        
        values.forEach((el, idx) => {
            let v = parseInt(el.value || el.innerText) || 0;
            dTotals[idx] += v; 
            if ([1, 5, 9, 13].includes(idx)) {
                rSum += v;
            }
        });
        
        let rowTotalCell = row.querySelector(".d-row-total");
        if(rowTotalCell) rowTotalCell.innerText = rSum;
    });

    updateTableFoot("daily-foot", dTotals, [1, 5, 9, 13]);

    // 2. Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª
    let mTotals = new Array(16).fill(0);
    document.querySelectorAll("#muni-body tr").forEach(row => {
        let rSum = 0;
        let values = row.querySelectorAll(".m-input, .m-val");
        
        values.forEach((el, idx) => {
            let v = parseInt(el.value || el.innerText) || 0;
            mTotals[idx] += v;
            if ([1, 5, 9, 13].includes(idx)) {
                rSum += v;
            }
        });
        let rowTotalCell = row.querySelector(".m-row-total");
        if(rowTotalCell) rowTotalCell.innerText = rSum;
    });

    updateTableFoot("muni-foot", mTotals, [1, 5, 9, 13]);
    updateChart(dTotals);
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ù„Ø§ ØªÙ„Ù…Ø³Ù‡Ø§ØŒ Ù‡ÙŠ ØªØ¹Ù…Ù„ Ù…Ø¹ Ø£ÙŠ index ØªØ±Ø³Ù„ Ù„Ù‡Ø§)
function updateTableFoot(id, totals, targetIndices) {
    let foot = document.getElementById(id);
    let html = `<td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</td>`;
    totals.forEach(v => { html += `<td>${v}</td>`; });
    
    let grandTotal = targetIndices.reduce((sum, idx) => sum + totals[idx], 0);
    
    html += `<td style="background:#ffd700; color:black; font-weight:900;">${grandTotal}</td>`;
    foot.innerHTML = html;
}
function updateChart(t) { const ctx = document.getElementById('mainChart').getContext('2d'); if(myChart) myChart.destroy(); myChart = new Chart(ctx, { type: 'bar', data: { labels: ['Ø§Ù„Ø¥Ø³Ø¹Ø§Ù', 'Ø­ÙˆØ§Ø¯Ø«', 'Ø§Ù„Ø­Ø±Ø§Ø¦Ù‚', 'Ù…Ø®ØªÙ„ÙØ©'], datasets: [{ label: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', data: [t[1], t[5], t[9], t[13]], backgroundColor: ['#4caf50', '#ff9800', '#f44336', '#2196f3'] }] }, options: { responsive: true, maintainAspectRatio: false } }); }
function getWeekDays(w) { 
    if(!w) return ["-","-","-","-","-","-","-"]; 
    let [year, week] = w.split('-W'); 
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
    let d = new Date(year, 0, 1 + (week - 1) * 7); 
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯
    while (d.getDay() !== 0) d.setDate(d.getDate() - 1); 
    
    // Ø²ÙŠØ§Ø¯Ø© ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª Ù„Ø¶Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨
    d.setDate(d.getDate() + 1); 
    
    let days = []; 
    for(let i=0; i<7; i++) { 
        let n = new Date(d); 
        n.setDate(d.getDate() + i); 
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ø¨ØµÙŠØºØ© YYYY-MM-DD
        let dateStr = n.toISOString().split('T')[0]; 
        days.push(dateStr); 
    } 
    return days; 
}
function changeWeek(){ currentWeek = document.getElementById("week-picker").value; renderSystem(); updateStatusPanel(); }
async function updateStatusPanel() { if(currentUser !== "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") return; const grid = document.getElementById("status-grid"); grid.innerHTML = ""; const snapshot = await db.ref('data/' + currentWeek).once('value'); const cloudData = snapshot.val() || {}; Object.keys(unitConfig).forEach(u => { if(u === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") return; let isSent = !!cloudData[u]; grid.innerHTML += `<div style="background:${isSent ? 'var(--success)' : 'var(--danger)'}; color:white; padding:10px; border-radius:10px; text-align:center; font-weight:700; font-size:12px;">${u}<br>${isSent ? 'âœ“' : 'âœ˜'}</div>`; }); }
async function changeMyPassword() { const { value: p } = await Swal.fire({ title: 'ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', input: 'text' }); if(p) { await db.ref('passwords/' + currentUser).set(p); localStorage.setItem("pass_" + currentUser, p); Swal.fire("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«", "", "success"); } }
async function revealUnitPass() { let opts = {}; Object.keys(unitConfig).forEach(u => { if(u !== "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") opts[u]=u; }); const { value: unit } = await Swal.fire({ title: 'ÙƒØ´Ù Ø§Ù„ÙƒÙˆØ¯', input: 'select', inputOptions: opts }); if(unit) { const snap = await db.ref('passwords/' + unit).once('value'); Swal.fire('Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ', `<b style="font-size:30px;">${snap.val() || "1111"}</b>`, 'info'); } }
function updateTicker() { let total = 0; db.ref('data/' + currentWeek).once('value').then(snap => { const data = snap.val() || {}; Object.values(data).forEach(u => { if(u.daily) u.daily.forEach(row => { total += (parseInt(row[1])||0) + (parseInt(row[5])||0) + (parseInt(row[9])||0) + (parseInt(row[13])||0); }); }); document.getElementById('ticker-text').innerText = `Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ÙˆÙ„Ø§ÙŠØ©: (${total}) ØªØ¯Ø®Ù„ â€¢ Ù…ØµÙ„Ø­Ø© Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© â€¢ Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© â€¢`; }); }
function getAllMunis() { let a = []; Object.keys(unitConfig).forEach(u => { if(u!=="Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") unitConfig[u].forEach(m => { if(!a.includes(m)) a.push(m); }); }); return a; }
function sendNotif() { let target = document.getElementById("notif-target").value; let msg = document.getElementById("notif-msg").value; if(!msg) return; db.ref('notifications/' + target).set(msg); Swal.fire("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹", "", "success"); document.getElementById("notif-msg").value = ""; }
function checkNotifications() { db.ref('notifications/' + currentUser).on('value', (snap) => { let msg = snap.val(); if(msg) { document.getElementById("notif-text").innerText = msg; document.getElementById("unit-notification").classList.remove("hidden"); } else { document.getElementById("unit-notification").classList.add("hidden"); } }); }
function clearNotif() { db.ref('notifications/' + currentUser).remove(); }
// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…ØªØ·ÙˆØ± ====================
let globalArchiveData = {};
let currentArchiveView = 'timeline';
let selectedArchiveWeek = null;

const CATEGORIES = [
    { label: 'Ø§Ù„Ø¥Ø³Ø¹Ø§Ù',       color: '#4caf50', cols: [0,1,2,3]   },
    { label: 'Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±',  color: '#ff9800', cols: [4,5,6,7]   },
    { label: 'Ø§Ù„Ø­Ø±Ø§Ø¦Ù‚',       color: '#f44336', cols: [8,9,10,11] },
    { label: 'Ù…Ø®ØªÙ„ÙØ©',        color: '#2196f3', cols: [12,13,14,15]}
];
const MONTHS_AR = ["Ø¬Ø§Ù†ÙÙŠ","ÙÙŠÙØ±ÙŠ","Ù…Ø§Ø±Ø³","Ø£ÙØ±ÙŠÙ„","Ù…Ø§ÙŠ","Ø¬ÙˆØ§Ù†","Ø¬ÙˆÙŠÙ„ÙŠØ©","Ø£ÙˆØª","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù…Ù† Firebase
async function loadArchive() {
    try {
        console.log('ğŸ“‚ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù…Ù† Firebase...');
        const snapshot = await db.ref('data').once('value');
        globalArchiveData = snapshot.val() || {};

        const keys = Object.keys(globalArchiveData);
        console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ:', keys.length, 'Ø£Ø³Ø¨ÙˆØ¹:', keys);

        const yearSelect = document.getElementById("arc-year");
        if (!yearSelect) { console.warn('âš ï¸ Ø¹Ù†ØµØ± arc-year ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

        yearSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø© --</option>';

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        let years = new Set();
        keys.forEach(w => {
            if (currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
                years.add(w.split('-')[0]);
            } else {
                // Ø§Ù„ÙˆØ­Ø¯Ø©: ÙÙ‚Ø· Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§
                if (globalArchiveData[w] && globalArchiveData[w][currentUser]) {
                    years.add(w.split('-')[0]);
                }
            }
        });

        [...years].sort().reverse().forEach(y => {
            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
        });

        // ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        fillCompareWeeks();
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', [...years]);

    } catch(e) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ:", e);
    }
}

// ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±
function updateMonthFilter() {
    const year = document.getElementById("arc-year").value;
    const monthSelect = document.getElementById("arc-month");
    monthSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± --</option>';
    if (!year) return;
    
    let months = new Set();
    Object.keys(globalArchiveData).forEach(w => {
        let [y, wk] = w.split('-W');
        if (y !== year) return;
        
        // Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§
        if (currentUser !== "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
            if (!(globalArchiveData[w] && globalArchiveData[w][currentUser])) return;
        }
        
        let d = new Date(year, 0, 1 + (wk - 1) * 7);
        months.add(d.getMonth() + 1);
    });
    
    if (months.size === 0) {
        monthSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</option>';
        return;
    }
    
    [...months].sort((a,b) => a-b).forEach(m => {
        monthSelect.innerHTML += `<option value="${m}">${MONTHS_AR[m-1]}</option>`;
    });

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø±
    selectedArchiveWeek = null;
    document.getElementById('archive-content-area').innerHTML = '';
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
function fillCompareWeeks() {
    // Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: ÙÙ‚Ø· Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§
    let weeks = Object.keys(globalArchiveData).filter(w => {
        if (currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") return true;
        return !!(globalArchiveData[w] && globalArchiveData[w][currentUser]);
    }).sort().reverse();

    const selects = ['compare-week-1', 'compare-week-2'];
    selects.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø£Ø³Ø¨ÙˆØ¹ --</option>';
        weeks.forEach(w => {
            el.innerHTML += `<option value="${w}">${w}</option>`;
        });
    });
}

// ØªØ­Ø¯ÙŠØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶
function setArchiveView(view) {
    currentArchiveView = view;
    const timelineBtn = document.getElementById('view-timeline-btn');
    const compareBtn  = document.getElementById('view-compare-btn');
    const compareArea = document.getElementById('compare-area');
    
    if (view === 'timeline') {
        timelineBtn.style.background = 'var(--primary)';
        compareBtn.style.background  = '#607d8b';
        compareArea.style.display    = 'none';
        loadArchiveView();
    } else {
        compareBtn.style.background  = '#1a237e';
        timelineBtn.style.background = '#607d8b';
        compareArea.style.display    = 'block';
        fillCompareWeeks();
        document.getElementById('archive-content-area').innerHTML = '';
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
function loadArchiveView() {
    const year  = document.getElementById("arc-year").value;
    const month = document.getElementById("arc-month").value;
    if (!year || !month) return;
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹: ØªÙ„Ùƒ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    let weeks = Object.keys(globalArchiveData).filter(w => {
        let [y, wk] = w.split('-W');
        if (y !== year) return false;
        let d = new Date(year, 0, 1 + (wk - 1) * 7);
        if ((d.getMonth() + 1) != month) return false;
        
        // Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        if (currentUser !== "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
            return !!(globalArchiveData[w] && globalArchiveData[w][currentUser]);
        }
        return true;
    }).sort();
    
    if (weeks.length === 0) {
        document.getElementById('archive-content-area').innerHTML = `
            <div style="text-align:center; padding:40px; color:#999;">
                <i class="fa-solid fa-folder-open" style="font-size:48px; margin-bottom:15px; display:block;"></i>
                <p style="font-size:16px; font-weight:700;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
                <p style="font-size:13px; color:#bbb;">ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†"</p>
            </div>`;
        return;
    }
    
    renderTimeline(weeks, year, month);
}

// Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø£Ø³Ø¨ÙˆØ¹ Ù…Ø¹ÙŠÙ† - Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
// Ø§Ù„Ø¨Ù†ÙŠØ©: data/2026-W07/unitName/daily/[day]/[col]
function calcWeekTotals(weekKey) {
    const weekData = globalArchiveData[weekKey] || {};
    let totals = new Array(16).fill(0);

    if (currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") {
        // Ø§Ù„Ù…ØªØ­ÙƒÙ…: ÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        Object.keys(weekData).forEach(unitName => {
            if (unitName === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©") return;
            const daily = (weekData[unitName] || {}).daily || {};
            Object.values(daily).forEach(row => {
                if (!row) return;
                Object.entries(row).forEach(([i, v]) => {
                    totals[parseInt(i)] += parseInt(v) || 0;
                });
            });
        });
    } else {
        // ÙˆØ­Ø¯Ø© Ø¹Ø§Ø¯ÙŠØ©: ØªØ¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ ÙÙ‚Ø·
        const daily = (weekData[currentUser] || {}).daily || {};
        Object.values(daily).forEach(row => {
            if (!row) return;
            Object.entries(row).forEach(([i, v]) => {
                totals[parseInt(i)] += parseInt(v) || 0;
            });
        });
    }

    return totals;
}

// Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ ÙØ¦Ø© Ù…Ø¹ÙŠÙ†Ø©
function catTotal(totals, cols) {
    return cols.reduce((s, i) => s + (totals[i] || 0), 0);
}

// ========== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ ==========
function renderTimeline(weeks, year, month) {
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹
    const weeksData = weeks.map(w => ({
        key: w,
        num: w.split('-W')[1],
        totals: calcWeekTotals(w)
    }));
    
    // Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ù†Ø³Ø¨ÙŠ
    const maxTotal = Math.max(...weeksData.map(d => catTotal(d.totals, [1,5,9,13])), 1);
    
    let html = `
        <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø± -->
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:25px;">
            ${CATEGORIES.map(cat => {
                const monthTotal = weeksData.reduce((s, d) => s + catTotal(d.totals, cat.cols), 0);
                return `
                <div style="background:${cat.color}15; border:2px solid ${cat.color}; border-radius:12px; padding:15px; text-align:center;">
                    <div style="font-size:28px; font-weight:900; color:${cat.color};">${monthTotal}</div>
                    <div style="font-size:13px; font-weight:700; color:#555; margin-top:5px;">${cat.label}</div>
                </div>`;
            }).join('')}
        </div>
        
        <!-- Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ -->
        <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 15px 0; color:var(--primary); font-weight:900;">
                <i class="fa-solid fa-timeline"></i> 
                Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ - ${MONTHS_AR[month-1]} ${year}
            </h4>
            <div style="display:flex; gap:12px; overflow-x:auto; padding-bottom:10px;">
                ${weeksData.map(d => {
                    const grandTotal  = catTotal(d.totals, [1,5,9,13]);
                    const heightPct   = Math.max(Math.round((grandTotal / maxTotal) * 100), 8);
                    const isSelected  = selectedArchiveWeek === d.key;
                    
                    return `
                    <div onclick="selectArchiveWeek('${d.key}')" style="
                        flex: 0 0 110px;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
                        <div style="height:120px; display:flex; align-items:flex-end; margin-bottom:8px; background:#f5f5f5; border-radius:8px; padding:5px; position:relative;">
                            ${CATEGORIES.map(cat => {
                                const val = catTotal(d.totals, cat.cols);
                                const pct = grandTotal > 0 ? Math.round((val / Math.max(grandTotal,1)) * heightPct) : 0;
                                return pct > 0 ? `<div style="
                                    flex:1;
                                    height:${pct * 1.1}px;
                                    background:${cat.color};
                                    margin:0 1px;
                                    border-radius:4px 4px 0 0;
                                    min-height:4px;
                                    transition:0.3s;
                                " title="${cat.label}: ${val}"></div>` : '';
                            }).join('')}
                        </div>
                        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ -->
                        <div style="
                            background: ${isSelected ? 'var(--primary)' : 'white'};
                            color: ${isSelected ? 'white' : '#333'};
                            border: 2px solid ${isSelected ? 'var(--primary)' : '#e0e0e0'};
                            border-radius: 10px;
                            padding: 10px 8px;
                            text-align: center;
                            box-shadow: ${isSelected ? '0 4px 15px rgba(26,35,126,0.3)' : '0 2px 8px rgba(0,0,0,0.08)'};
                            transition: all 0.3s;
                        " onmouseover="if('${d.key}'!==selectedArchiveWeek) { this.style.borderColor='var(--primary)'; this.style.background='#f0f4ff'; }"
                           onmouseout="if('${d.key}'!==selectedArchiveWeek) { this.style.borderColor='#e0e0e0'; this.style.background='white'; }">
                            <div style="font-size:11px; opacity:0.8; margin-bottom:3px;">Ø£Ø³Ø¨ÙˆØ¹</div>
                            <div style="font-size:18px; font-weight:900;">${d.num}</div>
                            <div style="font-size:20px; font-weight:900; color:${isSelected ? '#ffd700' : 'var(--primary)'}; margin:3px 0;">${grandTotal}</div>
                            <div style="font-size:10px; opacity:0.7;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
            
            <!-- Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
            <div style="display:flex; gap:15px; margin-top:10px; flex-wrap:wrap;">
                ${CATEGORIES.map(cat => `
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:14px; height:14px; background:${cat.color}; border-radius:3px;"></div>
                        <span style="font-size:12px; color:#555;">${cat.label}</span>
                    </div>`).join('')}
            </div>
        </div>
        
        <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
        <div id="archive-detail-panel"></div>
    `;
    
    document.getElementById('archive-content-area').innerHTML = html;
    
    // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ø£Ø³Ø¨ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø§Ù„Ø£Ø­Ø¯Ø« = Ø¢Ø®Ø± Ø¹Ù†ØµØ±)
    if (weeksData.length > 0) {
        const autoWeek = selectedArchiveWeek && weeks.includes(selectedArchiveWeek)
            ? selectedArchiveWeek
            : weeksData[weeksData.length - 1].key;
        selectedArchiveWeek = autoWeek;
        renderArchiveDetail(autoWeek);
    }
}

// Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ
function selectArchiveWeek(weekKey) {
    selectedArchiveWeek = weekKey;
    const year  = document.getElementById("arc-year").value;
    const month = document.getElementById("arc-month").value;
    let weeks = Object.keys(globalArchiveData).filter(w => {
        let [y, wk] = w.split('-W');
        if (y !== year) return false;
        let d = new Date(year, 0, 1 + (wk - 1) * 7);
        return (d.getMonth() + 1) == month;
    }).sort();
    renderTimeline(weeks, year, month);
}

// ========== Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ==========
function renderArchiveDetail(weekKey) {
    const totals     = calcWeekTotals(weekKey);
    const weekNum    = weekKey.split('-W')[1];
    const grandTotal = catTotal(totals, [1,5,9,13]);
    const unitLabel  = currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©" ? "Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª" : currentUser;
    
    const colLabels = ['Ø¹ Ø¹','Ø¹ Øª','Ù…Ø³Ø¹Ù','ÙˆÙØ§Ø©'];
    
    let html = `
        <div style="background:#f8f9fa; border-radius:12px; border:2px solid var(--primary); overflow:hidden; margin-top:5px;">
            
            <!-- Ø±Ø£Ø³ Ø§Ù„Ù„ÙˆØ­Ø© -->
            <div style="background:var(--primary); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:18px; font-weight:900;">
                        <i class="fa-solid fa-calendar-week"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekNum}
                    </div>
                    <div style="font-size:13px; opacity:0.85; margin-top:3px;">${weekKey} â€” ${unitLabel}</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:36px; font-weight:900; color:#ffd700;">${grandTotal}</div>
                    <div style="font-size:12px; opacity:0.85;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¯Ø®Ù„Ø§Øª</div>
                </div>
                <button onclick="loadWeekIntoMainTable('${weekKey}')" class="btn" 
                    style="background:white; color:var(--primary); margin:0; font-size:13px;">
                    <i class="fa-solid fa-eye"></i> Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                </button>
            </div>
            
            <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙØ¦Ø§Øª -->
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:0; border-bottom:2px solid #e0e0e0;">
                ${CATEGORIES.map(cat => {
                    const total = catTotal(totals, cat.cols);
                    const cols  = cat.cols.map((ci, i) => `
                        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #eee; font-size:13px;">
                            <span style="color:#666;">${colLabels[i]}</span>
                            <span style="font-weight:700;">${totals[ci] || 0}</span>
                        </div>`).join('');
                    return `
                    <div style="padding:15px; border-left:1px solid #e0e0e0; background:white;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span style="font-weight:900; font-size:14px; color:${cat.color};">${cat.label}</span>
                            <span style="font-size:22px; font-weight:900; color:${cat.color};">${total}</span>
                        </div>
                        ${cols}
                    </div>`;
                }).join('')}
            </div>
            
            <!-- Ø´Ø±ÙŠØ· ØªÙØµÙŠÙ„ÙŠ -->
            <div style="padding:15px 20px; background:white; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span style="font-size:13px; font-weight:700; color:#555;">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹:</span>
                <div style="flex:1; height:20px; border-radius:10px; overflow:hidden; display:flex; min-width:200px;">
                    ${CATEGORIES.map(cat => {
                        const val = catTotal(totals, cat.cols);
                        const pct = grandTotal > 0 ? Math.round((val / grandTotal) * 100) : 0;
                        return pct > 0 ? `<div style="
                            width:${pct}%;
                            background:${cat.color};
                            display:flex; align-items:center; justify-content:center;
                            font-size:11px; color:white; font-weight:700;
                            transition:0.3s;
                        " title="${cat.label}: ${val} (${pct}%)">${pct > 10 ? pct+'%' : ''}</div>` : '';
                    }).join('')}
                </div>
                <button onclick="printWeekReport('${weekKey}')" class="btn" style="background:#2e7d32; margin:0; padding:8px 15px; font-size:13px;">
                    <i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('archive-detail-panel').innerHTML = html;
}

// ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¨ÙˆØ¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
function loadWeekIntoMainTable(weekKey) {
    document.getElementById("week-picker").value = weekKey;
    changeWeek();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    Swal.fire({
        icon: 'success',
        title: 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        text: 'Ø£Ø³Ø¨ÙˆØ¹: ' + weekKey,
        timer: 1500,
        showConfirmButton: false,
        toast: true,
        position: 'top-end'
    });
}

// ========== Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† ==========
function runComparison() {
    const w1 = document.getElementById('compare-week-1').value;
    const w2 = document.getElementById('compare-week-2').value;
    
    if (!w1 || !w2) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©', 'warning');
        return;
    }
    if (w1 === w2) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†', 'warning');
        return;
    }
    
    const t1 = calcWeekTotals(w1);
    const t2 = calcWeekTotals(w2);
    const gt1 = catTotal(t1, [1,5,9,13]);
    const gt2 = catTotal(t2, [1,5,9,13]);
    const diff = gt2 - gt1;
    const diffPct = gt1 > 0 ? Math.round(((gt2 - gt1) / gt1) * 100) : 0;
    const diffColor = diff > 0 ? '#f44336' : diff < 0 ? '#4caf50' : '#607d8b';
    const diffIcon  = diff > 0 ? 'â–²' : diff < 0 ? 'â–¼' : 'â—';
    
    let html = `
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© -->
        <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; margin-bottom:20px;">
            <div style="background:var(--primary); color:white; padding:15px; border-radius:12px; text-align:center;">
                <div style="font-size:13px; opacity:0.85; margin-bottom:5px;">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</div>
                <div style="font-size:22px; font-weight:900;">${w1}</div>
                <div style="font-size:32px; font-weight:900; color:#ffd700; margin-top:5px;">${gt1}</div>
                <div style="font-size:12px; opacity:0.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
            </div>
            <div style="text-align:center; padding:10px;">
                <div style="font-size:24px; font-weight:900; color:${diffColor};">${diffIcon} ${Math.abs(diff)}</div>
                <div style="font-size:13px; color:${diffColor}; font-weight:700;">(${diffPct > 0 ? '+' : ''}${diffPct}%)</div>
                <div style="font-size:11px; color:#888; margin-top:5px;">ÙØ±Ù‚</div>
            </div>
            <div style="background:#37474f; color:white; padding:15px; border-radius:12px; text-align:center;">
                <div style="font-size:13px; opacity:0.85; margin-bottom:5px;">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
                <div style="font-size:22px; font-weight:900;">${w2}</div>
                <div style="font-size:32px; font-weight:900; color:#ffd700; margin-top:5px;">${gt2}</div>
                <div style="font-size:12px; opacity:0.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
            </div>
        </div>
        
        <!-- Ù…Ù‚Ø§Ø±Ù†Ø© ØªÙØµÙŠÙ„ÙŠØ© Ù„ÙƒÙ„ ÙØ¦Ø© -->
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px;">
            ${CATEGORIES.map(cat => {
                const v1 = catTotal(t1, cat.cols);
                const v2 = catTotal(t2, cat.cols);
                const d  = v2 - v1;
                const dc = d > 0 ? '#f44336' : d < 0 ? '#4caf50' : '#607d8b';
                const di = d > 0 ? 'â–²' : d < 0 ? 'â–¼' : 'â€”';
                const maxV = Math.max(v1, v2, 1);
                return `
                <div style="background:white; border:2px solid ${cat.color}30; border-radius:12px; padding:15px; border-right:4px solid ${cat.color};">
                    <div style="font-weight:900; color:${cat.color}; margin-bottom:12px; font-size:15px;">${cat.label}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <span style="font-size:22px; font-weight:900; color:var(--primary);">${v1}</span>
                        <span style="font-size:14px; font-weight:900; color:${dc};">${di} ${Math.abs(d)}</span>
                        <span style="font-size:22px; font-weight:900; color:#37474f;">${v2}</span>
                    </div>
                    <div style="display:flex; gap:3px; height:8px; border-radius:5px; overflow:hidden; background:#f5f5f5;">
                        <div style="width:${Math.round(v1/maxV*100)}%; background:var(--primary); border-radius:5px; transition:0.5s;"></div>
                    </div>
                    <div style="display:flex; gap:3px; height:8px; border-radius:5px; overflow:hidden; background:#f5f5f5; margin-top:3px;">
                        <div style="width:${Math.round(v2/maxV*100)}%; background:#37474f; border-radius:5px; transition:0.5s;"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:4px;">
                        <span style="font-size:10px; color:#888;">Ø£Ø³Ø¨ÙˆØ¹ 1</span>
                        <span style="font-size:10px; color:#888;">Ø£Ø³Ø¨ÙˆØ¹ 2</span>
                    </div>
                </div>`;
            }).join('')}
        </div>
        
        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© -->
        <div style="background:${diff > 0 ? '#fff3e0' : diff < 0 ? '#e8f5e9' : '#f5f5f5'}; border-radius:10px; padding:15px; margin-top:15px; text-align:center; border:2px solid ${diffColor}30;">
            <span style="font-weight:900; font-size:15px; color:${diffColor};">
                ${diff > 0 ? 'ğŸ“ˆ Ø§Ø±ØªÙØ¹ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù…Ù‚Ø¯Ø§Ø± ' + diff + ' ØªØ¯Ø®Ù„ (' + diffPct + '%)' :
                  diff < 0 ? 'ğŸ“‰ Ø§Ù†Ø®ÙØ¶ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù…Ù‚Ø¯Ø§Ø± ' + Math.abs(diff) + ' ØªØ¯Ø®Ù„ (' + Math.abs(diffPct) + '%)' :
                  'â– Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†'}
            </span>
        </div>
    `;
    
    document.getElementById('comparison-result').innerHTML = html;
}

// ========== Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ==========
function printArchiveReport() {
    const year  = document.getElementById("arc-year").value;
    const month = document.getElementById("arc-month").value;
    if (!year || !month) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    window.print();
}

function printWeekReport(weekKey) {
    loadWeekIntoMainTable(weekKey);
    setTimeout(() => window.print(), 800);
}

// Ø¯ÙˆØ§Ù„ Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚
function updateWeekFilter() {}
function loadArchivedWeek() {}
// Ø¯Ø§Ù„Ø© ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
async function generateMonthlyReport() {
    // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    Swal.fire({
        title: 'Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',
        text: 'ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø³Ø­Ø¨ ÙˆØ¥Ø­ØµØ§Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });
    
    try {
        // 2. Ø¬Ù„Ø¨ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø³Ù… data ÙÙŠ Firebase
        const snapshot = await db.ref('data').once('value');
        const allWeeks = snapshot.val() || {};
        
        // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ (16 Ø®Ø§Ù†Ø©)
        let monthlyTotals = new Array(16).fill(0);
        let hasData = false;

        // 3. Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        Object.keys(allWeeks).forEach(weekKey => {
            let unitsInData = allWeeks[weekKey];
            
            // Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹
            Object.keys(unitsInData).forEach(unitName => {
                // Ø´Ø±Ø·: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©" ÙŠØ¬Ù…Ø¹ Ø§Ù„ÙƒÙ„ØŒ ÙˆØ¥Ø°Ø§ ÙƒØ§Ù†Øª ÙˆØ­Ø¯Ø© ØªØ¬Ù…Ø¹ Ø­ØµØªÙ‡Ø§ ÙÙ‚Ø·
                if (currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©" || unitName === currentUser) {
                    let unitData = unitsInData[unitName].daily || [];
                    
                    unitData.forEach(row => {
                        if (row) {
                            hasData = true;
                            row.forEach((val, idx) => {
                                monthlyTotals[idx] += parseInt(val) || 0;
                            });
                        }
                    });
                }
            });
        });

        if (!hasData) {
            Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† Ù„ØªØ¬Ù…ÙŠØ¹Ù‡Ø§.", "warning");
            return;
        }

        // 4. Ø¨Ù†Ø§Ø¡ Ø³Ø·Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³ÙÙ„ÙŠ
        let mBody = document.getElementById("monthly-body");
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ÙÙ‚ÙŠ (Ø¹ Øª) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© [1, 5, 9, 13] ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹
        let totalAT = [1, 5, 9, 13].reduce((sum, idx) => sum + monthlyTotals[idx], 0);
        
        mBody.innerHTML = `
            <tr style="background: #f8f9fa;">
                <td style="font-weight:900; color:var(--primary);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</td>
                ${monthlyTotals.map(v => `<td style="font-weight:bold; font-size:16px;">${v}</td>`).join('')}
                <td style="background:#ffd700; font-weight:900; font-size:18px; color:black;">${totalAT}</td>
            </tr>
        `;

        // 5. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù†Ø²ÙˆÙ„ Ø¥Ù„ÙŠÙ‡ Ø¨Ø³Ù„Ø§Ø³Ø©
        document.getElementById('monthly-report-section').classList.remove('hidden');
        Swal.close();
        document.getElementById('monthly-report-section').scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error(error);
        Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­ØµÙŠÙ„Ø©", "error");
    }
}
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
(function() {
    const yr = document.getElementById("m-year");
    for(let i=2026; i<=2030; i++) yr.innerHTML += `<option value="${i}">${i}</option>`;
})();

// ØªÙØ¹ÙŠÙ„ Ø²Ø± Enter Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§
document.addEventListener('keydown', function(e) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø¶ØºÙˆØ· Ù‡Ùˆ Enter
    if (e.key === 'Enter' || e.keyCode === 13) {
        const target = e.target;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø´Ø· Ù‡Ùˆ input Ù…Ù† Ù†ÙˆØ¹ editable
        if (target.classList.contains('editable') || target.classList.contains('d-input') || target.classList.contains('m-input')) {
            e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
            const inputs = Array.from(document.querySelectorAll('.editable, .d-input, .m-input')).filter(input => {
                return input.offsetParent !== null; // ÙÙ‚Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
            });
            
            // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const currentIndex = inputs.indexOf(target);
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
            if (currentIndex > -1 && currentIndex < inputs.length - 1) {
                inputs[currentIndex + 1].focus();
                inputs[currentIndex + 1].select(); // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
            } else if (currentIndex === inputs.length - 1) {
                // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø¢Ø®Ø± Ø­Ù‚Ù„ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø£ÙˆÙ„
                inputs[0].focus();
                inputs[0].select();
            }
        }
    }
});

async function getMonthly() {
    const year = document.getElementById("m-year").value;
    const month = document.getElementById("m-month").value;
    const monthName = document.getElementById("m-month").options[document.getElementById("m-month").selectedIndex].text;
    
    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', didOpen: () => { Swal.showLoading(); } });

    const snap = await db.ref('data').once('value');
    const allData = snap.val() || {};
    let totals = new Array(16).fill(0);
    let found = false;

    Object.keys(allData).forEach(wk => {
        let [y, w] = wk.split('-W');
        let d = new Date(y, 0, 1 + (w - 1) * 7);
        if(y === year && (d.getMonth() + 1) == month) {
            Object.keys(allData[wk]).forEach(unit => {
                // ØªØ¬Ù…ÙŠØ¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¶Ùˆ Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ© Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø© Ù†ÙØ³Ù‡Ø§
                if(currentUser === "Ø§Ù„Ù…Ø¯ÙŠÙ€Ù€Ù€Ù€Ù€Ø±ÙŠØ©" || unit === currentUser) {
                    let data = allData[wk][unit].daily;
                    if(data) {
                        found = true;
                        data.forEach(row => { 
                            if(row) row.forEach((v, i) => totals[i] += parseInt(v)||0); 
                        });
                    }
                }
            });
        }
    });

    if(!found) {
        Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±", "info");
        document.getElementById("monthly-report-area").classList.add("hidden");
        return;
    }

    // Ø¨Ù†Ø§Ø¡ Ø³Ø·Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    let grandTotal = [1, 5, 9, 13].reduce((sum, i) => sum + totals[i], 0);
    let html = `<tr>
        <td style="background:#f9f9f9; font-weight:900;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±</td>`;
    totals.forEach(v => { html += `<td>${v}</td>`; });
    html += `<td style="background:yellow; font-weight:900;">${grandTotal}</td></tr>`;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    document.getElementById("m-report-title").innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­ØµÙŠÙ„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ø´Ù‡Ø±: ${monthName} ${year}`;
    document.getElementById("m-result-body").innerHTML = html;
    document.getElementById("monthly-report-area").classList.remove("hidden");
    
    Swal.close();
    // Ø§Ù„Ù†Ø²ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
    document.getElementById("monthly-report-area").scrollIntoView({ behavior: 'smooth' });
}
    </script>
  </body>
</html>
